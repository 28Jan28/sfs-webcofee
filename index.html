<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEBCofee - K√°vovar syst√©m</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- EmailJS integrace -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            // EmailJS inicializace s public key
            emailjs.init("7hyRlSOcJZyjww9Ng"); // Spr√°vn√Ω ve≈ôejn√Ω kl√≠ƒç pro slu≈æbu EmailJS
        })();
    </script>
    <style>
        :root {
            --gray: #999999;
            --red: #EB3C24;
            --black: #000000;
            --white: #FFFFFF;
        }
        
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        body {
            background: url('https://public.youware.com/users-website-assets/prod/0f1254a1-1aa6-4aec-a97b-8bd81c837f2a/74a91e13e3f944929d8a3d46779fc836.jpg') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            z-index: -1;
        }
        
        .process-block {
            background: linear-gradient(135deg, var(--red) 0%, #ff4436 100%);
            color: var(--white);
            border: 2px solid var(--black);
            box-shadow: 4px 4px 0px var(--black);
            transition: all 0.2s ease;
        }
        
        .process-block:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px var(--black);
        }
        
        /* Mobile touch optimizations */
        .touch-manipulation {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Larger touch targets for mobile */
        @media (max-width: 640px) {
            .coffee-button {
                padding: 1rem;
            }
            
            input, select, button {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Better spacing for mobile */
            .space-y-2 > * + * {
                margin-top: 0.75rem;
            }
            
            /* Mobile table improvements */
            table {
                font-size: 0.875rem;
            }
            
            table th, table td {
                padding: 0.5rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 120px;
            }
        }
        
        .operational-block {
            background: linear-gradient(135deg, var(--white) 0%, #f8f8f8 100%);
            color: var(--black);
            border: 2px solid var(--red);
            box-shadow: 3px 3px 0px var(--red);
        }
        
        .support-block {
            background: linear-gradient(135deg, var(--gray) 0%, #aaaaaa 100%);
            color: var(--white);
            border: 2px solid var(--black);
            box-shadow: 3px 3px 0px var(--black);
        }
        
        .card {
            background: linear-gradient(135deg, var(--white) 0%, #fafafa 100%);
            border: 3px solid var(--red);
            box-shadow: 6px 6px 0px var(--black);
            border-radius: 8px;
            backdrop-filter: blur(5px);
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--red) 0%, #ff4436 100%);
            color: var(--white);
            border: 2px solid var(--black);
            box-shadow: 3px 3px 0px var(--black);
            transition: all 0.1s ease;
            border-radius: 6px;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px var(--black);
            background: linear-gradient(135deg, #ff4436 0%, var(--red) 100%);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--white) 0%, #f5f5f5 100%);
            color: var(--black);
            border: 2px solid var(--red);
            box-shadow: 3px 3px 0px var(--red);
            transition: all 0.1s ease;
            border-radius: 6px;
            font-weight: bold;
        }
        
        .btn-secondary:hover {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px var(--red);
            background: linear-gradient(135deg, #f5f5f5 0%, var(--white) 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--black) 0%, #333333 100%);
            color: var(--white);
            border: 2px solid var(--red);
            box-shadow: 3px 3px 0px var(--red);
            transition: all 0.1s ease;
            border-radius: 6px;
            font-weight: bold;
        }
        
        .btn-danger:hover {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px var(--red);
            background: linear-gradient(135deg, #333333 0%, var(--black) 100%);
        }
        
        .input-field {
            background: var(--white);
            border: 3px solid var(--red);
            box-shadow: inset 2px 2px 0px #ffebeb;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            box-shadow: inset 2px 2px 0px #ffebeb, 0 0 0 3px rgba(235, 60, 36, 0.3);
            transform: scale(1.02);
        }
        
        .coffee-icon { 
            font-size: 3rem;
            filter: drop-shadow(3px 3px 0px var(--red));
        }
        
        .title-text {
            color: var(--black);
            text-shadow: 2px 2px 0px var(--red);
            font-weight: bold;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--white);
            border-top: 4px solid var(--red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .balance-positive { 
            color: var(--black); 
            text-shadow: 1px 1px 0px var(--white);
        }
        .balance-negative { 
            color: var(--red); 
            text-shadow: 1px 1px 0px var(--white);
            font-weight: bold;
        }
        
        .transaction-credit { 
            color: var(--black); 
            font-weight: bold; 
            background: rgba(235, 60, 36, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .transaction-debit { 
            color: var(--red); 
            font-weight: bold;
            background: rgba(153, 153, 153, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .transaction-descaling {
            color: #2563eb; 
            font-weight: bold;
            background: rgba(37, 99, 235, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 3px 3px 0px var(--black);
        }
        
        th, td {
            border: 1px solid var(--red);
            padding: 12px 8px;
        }
        
        th {
            background: linear-gradient(135deg, var(--red) 0%, #ff4436 100%);
            color: var(--white);
            font-weight: bold;
            text-shadow: 1px 1px 0px var(--black);
        }
        
        tr:nth-child(even) {
            background: linear-gradient(135deg, #fafafa 0%, var(--white) 100%);
        }
        
        tr:nth-child(odd) {
            background: var(--white);
        }
        
        .admin-login-prompt {
            background: linear-gradient(135deg, var(--red) 0%, #ff4436 100%);
            color: var(--white);
            border: 3px solid var(--black);
            box-shadow: 4px 4px 0px var(--black);
            border-radius: 8px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .success-message {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: var(--white);
            border: 2px solid var(--black);
            box-shadow: 3px 3px 0px var(--black);
            border-radius: 6px;
        }
        
        .error-message {
            background: linear-gradient(135deg, var(--red) 0%, #ff4436 100%);
            color: var(--white);
            border: 2px solid var(--black);
            box-shadow: 3px 3px 0px var(--black);
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="coffee-icon mb-4">‚òï</div>
            <div class="text-3xl title-text mb-4">WEBCofee</div>
            <div class="loading-spinner mx-auto"></div>
        </div>
    </div>

    <!-- RFID Login Screen -->
    <div id="loginScreen" class="hidden min-h-screen flex items-center justify-center p-2 sm:p-4">
        <div class="card p-4 sm:p-6 max-w-lg w-full text-center relative">
            <!-- ƒåasov√© a datumov√© informace - responzivn√≠ pozice -->
            <div class="absolute top-2 sm:top-3 left-2 sm:left-3 text-left">
                <div id="currentTime" class="text-sm sm:text-lg font-bold" style="color: var(--red);">00:00:00</div>
                <div id="currentDate" class="text-xs sm:text-sm font-medium" style="color: var(--black);">1.1.2025</div>
                <div id="nameDay" class="text-xs font-medium" style="color: var(--gray);">Sv√°tek m√°: ...</div>
            </div>
            
            <!-- Logo firmy - responzivn√≠ pozice -->
            <div class="absolute top-2 sm:top-3 right-2 sm:right-3">
                <img src="60v4bruhye.png" alt="SFS Logo" class="h-6 sm:h-8 w-auto">
            </div>
            
            <!-- Stav pokladny - responzivn√≠ pozice -->
            <div class="absolute bottom-2 sm:bottom-3 right-2 sm:right-3 text-right">
                <div class="text-base sm:text-lg" style="color: var(--red);">üí∞</div>
                <div id="cashRegisterStatus" class="text-xs font-bold" style="color: var(--black);">0 Kƒç</div>
            </div>
            
            <div class="coffee-icon mb-4 mt-12 sm:mt-8 text-3xl sm:text-4xl">‚òï</div>
            <h1 class="text-xl sm:text-2xl title-text mb-2">WEBCofee</h1>
            <p class="text-black mb-4 sm:mb-6 font-medium text-sm sm:text-base px-2">P≈ôilo≈æte RFID kartu pro p≈ôihl√°≈°en√≠</p>
            
            <div class="relative mb-4 sm:mb-6">
                <input 
                    type="text" 
                    id="rfidInput" 
                    class="input-field w-full p-3 sm:p-4 text-center text-base sm:text-lg font-mono font-bold"
                    placeholder="ƒåek√°m na sken karty..."
                    autocomplete="off"
                    autofocus
                >
            </div>
            
            <div class="text-xs sm:text-sm mb-3 sm:mb-4 px-2" style="color: var(--gray); font-weight: bold;">
                Karta se naƒçte automaticky po p≈ôilo≈æen√≠
            </div>
            
            <!-- Authentication Methods -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                <button id="nfcLoginBtn" class="btn-primary px-4 py-3 text-sm min-h-[44px] touch-manipulation">
                    üì± NFC p≈ôihl√°≈°en√≠
                </button>
                <button id="biometricLoginBtn" class="btn-primary px-4 py-3 text-sm min-h-[44px] touch-manipulation">
                    üëÜ Biometrick√©
                </button>
            </div>
            
            <div id="loginError" class="error-message mb-3 sm:mb-4 p-2 sm:p-3 hidden text-sm"></div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                <button id="adminLoginBtn" class="btn-secondary px-4 sm:px-6 py-3 sm:py-3 text-sm min-h-[44px] touch-manipulation">
                    üîß Admin p≈ô√≠stup
                </button>
                <button id="descalingBtn" class="btn-secondary px-4 sm:px-6 py-3 sm:py-3 text-sm min-h-[44px] touch-manipulation">
                    üßπ Odv√°pnƒõn√≠
                    <div id="lastDescalingDate" class="text-xs mt-1 opacity-80"></div>
                </button>
            </div>
            
            <!-- Zobrazen√≠ verze aplikace -->
            <div class="mt-3 sm:mt-4 text-center">
                <span class="text-xs sm:text-sm px-3 py-1 rounded-full" style="background: rgba(235, 60, 36, 0.1); color: var(--red); font-weight: bold; border: 1px solid var(--red);">
                    üìã WEBCofee v1.14 (Kiosk Mode)
                </span>
            </div>
            
            <!-- Admin RFID Prompt -->
            <div id="adminRfidPrompt" class="hidden mt-3 sm:mt-4">
                <div class="admin-login-prompt p-3 sm:p-4">
                    <div class="text-base sm:text-lg font-bold mb-2">üîí Admin p≈ô√≠stup</div>
                    <p class="text-xs sm:text-sm mb-3 sm:mb-4">P≈ôilo≈æte admin RFID kartu</p>
                    <input 
                        type="text" 
                        id="adminRfidInput" 
                        class="input-field w-full p-3 text-center font-mono font-bold text-sm sm:text-base"
                        placeholder="ƒåek√°n√≠ na admin kartu..."
                        autocomplete="off"
                    >
                    <div id="adminLoginError" class="error-message p-2 mt-2 sm:mt-3 hidden text-xs sm:text-sm"></div>
                    <div class="text-xs mt-2 text-white">Tip: Pro admin p≈ô√≠stup p≈ôilo≈æte spr√°vnou kartu</div>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-0 mt-3">
                        <button id="manualAdminBtn" class="btn-primary sm:mr-2 px-4 py-3 text-sm min-h-[44px] flex-1 sm:flex-none touch-manipulation">
                            Zadat ruƒçnƒõ
                        </button>
                        <button id="cancelAdminBtn" class="btn-secondary px-4 py-3 text-sm min-h-[44px] flex-1 sm:flex-none touch-manipulation">
                            Zru≈°it
                        </button>
                    </div>
                </div>
            </div>
            

        </div>
    </div>

    <!-- Descaling Auth Prompt -->
    <div id="descalingAuthPrompt" class="hidden min-h-screen flex items-center justify-center p-2 sm:p-4">
        <div class="card p-4 sm:p-6 max-w-lg w-full text-center">
            <div class="text-base sm:text-lg font-bold mb-2">üßπ Odv√°pnƒõn√≠ - Ovƒõ≈ôen√≠</div>
            <p class="text-xs sm:text-sm mb-3 sm:mb-4">P≈ôilo≈æte RFID kartu pro ovƒõ≈ôen√≠</p>
            <input 
                type="text" 
                id="descalingRfidInput" 
                class="input-field w-full p-3 text-center font-mono font-bold text-sm sm:text-base"
                placeholder="ƒåek√°n√≠ na kartu..."
                autocomplete="off"
            >
            <div id="descalingAuthError" class="error-message p-2 mt-2 sm:mt-3 hidden text-xs sm:text-sm"></div>
            <div class="text-xs mt-2 text-white">Tip: M≈Ø≈æete pou≈æ√≠t libovolnou kartu nebo biometrick√© p≈ôihl√°≈°en√≠</div>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-0 mt-3">
                <button id="descalingNfcBtn" class="btn-primary sm:mr-2 px-4 py-3 text-sm min-h-[44px] flex-1 sm:flex-none touch-manipulation">
                    üì± NFC
                </button>
                <button id="descalingBioBtn" class="btn-primary sm:mr-2 px-4 py-3 text-sm min-h-[44px] flex-1 sm:flex-none touch-manipulation">
                    üëÜ Biometrick√©
                </button>
                <button id="cancelDescalingAuthBtn" class="btn-secondary px-4 py-3 text-sm min-h-[44px] flex-1 sm:flex-none touch-manipulation">
                    Zru≈°it
                </button>
            </div>
        </div>
    </div>
    
    <!-- Descaling Date Form -->
    <div id="descalingDateForm" class="hidden min-h-screen flex items-center justify-center p-2 sm:p-4">
        <div class="card p-4 sm:p-6 max-w-lg w-full text-center">
            <div class="text-base sm:text-lg font-bold mb-2">üßπ Odv√°pnƒõn√≠ - Zad√°n√≠ data</div>
            <p class="text-xs sm:text-sm mb-3 sm:mb-4">Zadejte datum proveden√≠ odv√°pnƒõn√≠</p>
            
            <div class="mb-3">
                <label for="descalingDate" class="block text-white text-sm mb-1">Datum odv√°pnƒõn√≠:</label>
                <input 
                    type="date" 
                    id="descalingDate" 
                    class="bg-white text-black rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-red-600" 
                    required
                />
            </div>
            
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-0 mt-3">
                <button id="saveDescalingBtn" class="btn-primary sm:mr-2 px-4 py-3 text-sm min-h-[44px] flex-1 sm:flex-none touch-manipulation">
                    Ulo≈æit
                </button>
                <button id="cancelDescalingDateBtn" class="btn-secondary px-4 py-3 text-sm min-h-[44px] flex-1 sm:flex-none touch-manipulation">
                    Zru≈°it
                </button>
            </div>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="userDashboard" class="hidden min-h-screen p-2 sm:p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="card p-3 sm:p-6 mb-4 sm:mb-6">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-0">
                    <div class="text-center sm:text-left">
                        <h1 class="text-lg sm:text-2xl title-text" id="userDashboardName">Jm√©no u≈æivatele</h1>
                        <p class="text-black font-medium text-sm sm:text-base" id="userDashboardCard">Karta: 1234567890</p>
                    </div>
                    <div class="text-center">
                        <div class="text-sm sm:text-lg font-bold" style="color: var(--red);">üí∞ Kredit</div>
                        <div class="text-2xl sm:text-3xl font-bold" id="userDashboardBalance">0 Kƒç</div>
                    </div>
                    <button id="userLogoutBtn" class="btn-danger px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation">
                        üö™ Odhl√°sit se
                    </button>
                </div>
            </div>
            
            <!-- Coffee Selection -->
            <div class="flex justify-center mb-4 sm:mb-6">
                <div class="process-block p-4 sm:p-6 text-center rounded-lg max-w-xs w-full">
                    <button class="coffee-button w-full h-full min-h-[100px] sm:min-h-[120px] touch-manipulation" data-product="K√ÅVA" data-price="5">
                        <div class="text-3xl sm:text-4xl mb-2">‚òï</div>
                        <div class="font-bold text-lg sm:text-xl">K√ÅVA</div>
                        <div class="text-white font-bold text-sm sm:text-base">üíµ 5 Kƒç</div>
                    </button>
                </div>
            </div>
            
            <!-- Transactions -->
            <div class="card p-3 sm:p-6">
                <h2 class="text-lg sm:text-xl title-text mb-3 sm:mb-4">üìä Va≈°e transakce</h2>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm sm:text-base">
                        <thead>
                            <tr>
                                <th class="text-left p-2 sm:p-3">üìÖ Datum</th>
                                <th class="text-left p-2 sm:p-3">üìã Typ</th>
                                <th class="text-right p-2 sm:p-3">üí∞ ƒå√°stka</th>
                                <th class="text-left p-2 sm:p-3 hidden sm:table-cell">üìù Popis</th>
                            </tr>
                        </thead>
                        <tbody id="userTransactionsList">
                            <tr><td colspan="4" class="text-center p-3 font-medium">Naƒç√≠t√°n√≠ transakc√≠...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen p-2 sm:p-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="card p-3 sm:p-6 mb-4 sm:mb-6">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-0">
                    <div class="text-center sm:text-left">
                        <h1 class="text-lg sm:text-2xl title-text">üîß WEBCofee Admin</h1>
                        <p class="text-black font-medium text-sm sm:text-base">Spr√°va u≈æivatel≈Ø a transakc√≠</p>
                    </div>
                    <button id="adminLogoutBtn" class="btn-danger px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation">
                        üö™ Odhl√°sit se
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-6">
                <!-- User Management -->
                <div class="space-y-3 sm:space-y-6">
                    <div class="card p-3 sm:p-6">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-3 sm:mb-4 gap-2 sm:gap-0">
                            <h2 class="text-base sm:text-xl title-text">üë• Spr√°va u≈æivatel≈Ø</h2>
                            <button id="addUserBtn" class="btn-primary px-3 py-2 text-sm min-h-[44px] touch-manipulation">
                                ‚ûï P≈ôidat u≈æivatele
                            </button>
                        </div>
                        
                        <div class="space-y-2" id="userList">
                            <div class="text-center p-3 font-medium">Naƒç√≠t√°n√≠ u≈æivatel≈Ø...</div>
                        </div>
                            <p class="text-gray-500 p-3 font-medium text-sm sm:text-base">Naƒç√≠t√°n√≠ u≈æivatel≈Ø...</p>
                        </div>
                    </div>
                    
                    <!-- WEBCofee pokladna - nov√° karta -->
                    <div class="card p-3 sm:p-6">
                        <h2 class="text-base sm:text-xl title-text mb-3 sm:mb-4">üíµ WEBCofee pokladna</h2>
                        
                        <div class="mb-4 sm:mb-6">
                            <div class="text-sm sm:text-lg font-bold mb-2">Aktu√°ln√≠ stav pokladny:</div>
                            <div class="text-2xl sm:text-3xl font-bold balance-positive" id="cashRegisterAmount">
                                <span class="loading-spinner inline-block mr-2 w-5 h-5"></span> Naƒç√≠t√°n√≠...
                            </div>
                            <div class="text-xs sm:text-sm mt-2" style="color: var(--gray);">
                                Posledn√≠ aktualizace: <span id="cashRegisterLastUpdated">-</span>
                            </div>
                        </div>
                        
                        <form id="cashRegisterForm" class="space-y-3 sm:space-y-4">
                            <div>
                                <label class="block text-black mb-2 font-bold text-sm sm:text-base">üí∞ Nov√Ω stav pokladny (Kƒç)</label>
                                <input 
                                    type="number" 
                                    id="cashRegisterNewAmount" 
                                    placeholder="Zadejte ƒç√°stku"
                                    class="input-field w-full p-3 font-medium text-sm sm:text-base"
                                    required
                                    min="0"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-black mb-2 font-bold text-sm sm:text-base">üìù Pozn√°mka (voliteln√©)</label>
                                <input 
                                    type="text" 
                                    id="cashRegisterNote" 
                                    placeholder="Nap≈ô. 'V√Ωbƒõr hotovosti'"
                                    class="input-field w-full p-3 font-medium text-sm sm:text-base"
                                >
                            </div>
                            
                            <button 
                                type="submit" 
                                class="btn-primary w-full p-3 text-sm sm:text-base min-h-[44px] touch-manipulation"
                            >
                                üíæ Aktualizovat stav pokladny
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Credit & Transactions -->
                <div class="space-y-3 sm:space-y-6">
                    <div class="card p-3 sm:p-6">
                        <h2 class="text-base sm:text-xl title-text mb-3 sm:mb-4">üí≥ Dob√≠t kredit</h2>
                        
                        <form id="creditForm" class="space-y-3 sm:space-y-4">
                            <div>
                                <label class="block text-black mb-2 font-bold text-sm sm:text-base">üë§ Vyberte u≈æivatele</label>
                                <select id="creditUserId" class="input-field w-full p-3 font-medium text-sm sm:text-base" required>
                                    <option value="">Vyberte u≈æivatele...</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-black mb-2 font-bold text-sm sm:text-base">üí∞ ƒå√°stka (Kƒç)</label>
                                <input 
                                    type="number" 
                                    id="creditAmount" 
                                    placeholder="Zadejte ƒç√°stku"
                                    class="input-field w-full p-3 font-medium text-sm sm:text-base"
                                    required
                                    min="1"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-black mb-2 font-bold text-sm sm:text-base">üìù Pozn√°mka (voliteln√©)</label>
                                <input 
                                    type="text" 
                                    id="creditDescription" 
                                    placeholder="Nap≈ô. 'Dobit√≠ hotovost√≠'"
                                    class="input-field w-full p-3 font-medium text-sm sm:text-base"
                                >
                            </div>
                            
                            <button 
                                type="submit" 
                                class="btn-primary w-full p-3 text-sm sm:text-base min-h-[44px] touch-manipulation"
                            >
                                üí≥ Dob√≠t kredit
                            </button>
                        </form>
                    </div>
                    
                    <div class="card p-3 sm:p-6">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-3 sm:mb-4 gap-2 sm:gap-0">
                            <h2 class="text-base sm:text-xl title-text">üìà Historie transakc√≠</h2>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button id="sendMonthlyReportBtn" class="btn-primary px-3 sm:px-4 py-2 text-xs sm:text-sm min-h-[44px] touch-manipulation">
                                    üìä Otestovat mƒõs√≠ƒçn√≠ report
                                </button>
                                <button id="clearHistoryBtn" class="btn-danger px-3 sm:px-4 py-2 text-xs sm:text-sm min-h-[44px] touch-manipulation">
                                    üóëÔ∏è Smazat historii transakc√≠
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs sm:text-sm">
                                <thead>
                                    <tr>
                                        <th class="text-left p-2">üìÖ Datum</th>
                                        <th class="text-left p-2 hidden sm:table-cell">üë§ U≈æivatel</th>
                                        <th class="text-left p-2">üìã Typ</th>
                                        <th class="text-right p-2">üí∞ ƒå√°stka</th>
                                        <th class="text-left p-2 hidden lg:table-cell">üìù Popis</th>
                                    </tr>
                                </thead>
                                <tbody id="allTransactionsList">
                                    <tr><td colspan="5" class="text-center p-3 font-medium">Naƒç√≠t√°n√≠ transakc√≠...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit User Modal -->
    <div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
        <div class="card p-4 sm:p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h2 id="userModalTitle" class="text-lg sm:text-xl title-text mb-3 sm:mb-4">üë§ P≈ôidat u≈æivatele</h2>
            <form id="userForm">
                <input type="hidden" id="editUserId" value="">
                <input 
                    type="text" 
                    id="userRfidCard" 
                    placeholder="üîñ RFID karta (nap≈ô. 1234567890)"
                    class="input-field w-full p-3 mb-3 font-medium text-sm sm:text-base"
                    required
                >
                <input 
                    type="text" 
                    id="userNfcCard" 
                    placeholder="üì± NFC karta (nap≈ô. 6a:5b:3e:9c)"
                    class="input-field w-full p-3 mb-3 font-medium text-sm sm:text-base"
                >
                <input 
                    type="text" 
                    id="userName" 
                    placeholder="üë§ Jm√©no u≈æivatele"
                    class="input-field w-full p-3 mb-3 font-medium text-sm sm:text-base"
                    required
                >
                <input 
                    type="number" 
                    id="userBalance" 
                    placeholder="üí∞ Poƒç√°teƒçn√≠ kredit (Kƒç)"
                    class="input-field w-full p-3 mb-4 font-medium text-sm sm:text-base"
                    required
                >
                <div class="flex flex-col sm:flex-row sm:justify-end gap-2">
                    <button 
                        type="button" 
                        id="cancelUserBtn"
                        class="btn-secondary px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation order-2 sm:order-1"
                    >
                        ‚ùå Zru≈°it
                    </button>
                    <button 
                        type="submit" 
                        id="saveUserBtn"
                        class="btn-primary px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation order-1 sm:order-2"
                    >
                        ‚úÖ P≈ôidat u≈æivatele
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
        <div class="card p-4 sm:p-6 max-w-md w-full">
            <h2 class="text-lg sm:text-xl title-text mb-3 sm:mb-4">‚ö†Ô∏è Potvrzen√≠ smaz√°n√≠</h2>
            <p id="deleteUserName" class="text-black mb-4 sm:mb-6 font-medium text-sm sm:text-base">Opravdu chcete smazat tohoto u≈æivatele?</p>
            <div class="flex flex-col sm:flex-row sm:justify-end gap-2">
                <button 
                    type="button" 
                    id="cancelDeleteBtn"
                    class="btn-secondary px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation order-2 sm:order-1"
                >
                    ‚ùå Zru≈°it
                </button>
                <button 
                    type="button" 
                    id="confirmDeleteBtn"
                    class="btn-danger px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation order-1 sm:order-2"
                >
                    üóëÔ∏è Smazat
                </button>
            </div>
        </div>
    </div>
    
    <!-- Order Confirmation Modal -->
    <div id="orderConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
        <div class="card p-4 sm:p-6 max-w-md w-full">
            <h2 class="text-lg sm:text-xl title-text mb-3 sm:mb-4">‚òï Potvrdit objedn√°vku</h2>
            <p id="orderDetails" class="text-black mb-4 sm:mb-6 font-medium text-sm sm:text-base">Chcete si objednat k√°vu <span id="orderProduct"></span> za <span id="orderPrice"></span> Kƒç?</p>
            <div class="flex flex-col sm:flex-row sm:justify-end gap-2">
                <button 
                    type="button" 
                    id="cancelOrderBtn"
                    class="btn-secondary px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation order-2 sm:order-1"
                >
                    ‚ùå Zru≈°it
                </button>
                <button 
                    type="button" 
                    id="confirmOrderBtn"
                    class="btn-primary px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation order-1 sm:order-2"
                >
                    ‚úÖ Objednat
                </button>
            </div>
        </div>
    </div>
    
    <!-- First Confirmation Modal for History Deletion -->
    <div id="firstConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
        <div class="card p-4 sm:p-6 max-w-md w-full">
            <h2 class="text-lg sm:text-xl title-text mb-3 sm:mb-4">‚ö†Ô∏è Potvrzen√≠ smaz√°n√≠ historie</h2>
            <p class="text-black mb-3 sm:mb-4 font-medium text-sm sm:text-base">Chcete smazat ve≈°kerou historii transakc√≠?</p>
            <p class="text-black mb-4 sm:mb-6 font-medium text-sm sm:text-base">Pro pokraƒçov√°n√≠ p≈ôilo≈æte admin kartu:</p>
            <input 
                type="text" 
                id="firstConfirmAdminRfid" 
                class="input-field w-full p-3 mb-4 font-mono font-bold text-sm sm:text-base"
                placeholder="P≈ôilo≈æte admin kartu..."
                autocomplete="off"
            >
            <div class="flex justify-end">
                <button 
                    type="button" 
                    id="cancelFirstConfirmBtn" 
                    class="btn-secondary px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation"
                >
                    ‚ùå Zru≈°it
                </button>
            </div>
        </div>
    </div>

    <!-- Second Confirmation Modal for History Deletion -->
    <div id="secondConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
        <div class="card p-4 sm:p-6 max-w-md w-full">
            <h2 class="text-lg sm:text-xl title-text mb-3 sm:mb-4">‚ö†Ô∏è FIN√ÅLN√ç POTVRZEN√ç</h2>
            <p class="text-black mb-3 sm:mb-4 font-medium text-sm sm:text-base">OPRAVDU chcete smazat VE≈†KEROU historii transakc√≠?</p>
            <p class="text-black mb-3 sm:mb-4 font-medium text-sm sm:text-base">Tato akce je NEVRATN√Å!</p>
            <p class="text-black mb-4 sm:mb-6 font-medium text-sm sm:text-base">Pro definitivn√≠ potvrzen√≠ znovu p≈ôilo≈æte admin kartu:</p>
            <input 
                type="text" 
                id="secondConfirmAdminRfid" 
                class="input-field w-full p-3 mb-4 font-mono font-bold text-sm sm:text-base"
                placeholder="P≈ôilo≈æte admin kartu pro fin√°ln√≠ potvrzen√≠..."
                autocomplete="off"
            >
            <div class="flex justify-end">
                <button 
                    type="button" 
                    id="cancelSecondConfirmBtn" 
                    class="btn-secondary px-4 py-3 text-sm sm:text-base min-h-[44px] touch-manipulation"
                >
                    ‚ùå Zru≈°it
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 max-w-xs w-full card transition-opacity duration-300 opacity-0 z-50">
        <div class="flex p-4 items-start">
            <div id="toastIcon" class="mr-3 text-xl"></div>
            <div class="flex-1">
                <h3 id="toastTitle" class="font-bold"></h3>
                <p id="toastMessage" class="text-sm font-medium" style="color: var(--gray);"></p>
            </div>
            <button id="closeToastBtn" class="text-gray-400 hover:text-gray-600 font-bold">
                ‚ùå
            </button>
        </div>
    </div>

    <script>
        // Inicializace Supabase
        const supabaseUrl = 'https://ejzvytylzhtxqvpgyyic.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqenZ5dHlsemh0eHF2cGd5eWljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjY2NTksImV4cCI6MjA2NjM0MjY1OX0.r3KFR3ReWDg6izOvsUUJ5HrfegxSsfvjUIGmxqg6MVQ';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Glob√°ln√≠ promƒõnn√©
        let currentUser = null;
        let userToDelete = null;
        let currentOrder = null;
        let adminMode = false;
        
        // Data ƒçesk√Ωch sv√°tk≈Ø - mapov√°n√≠ data na jm√©no
        const czechNameDays = {
            "1.1": "Nov√Ω rok",
            "2.1": "Karina",
            "3.1": "Radmila",
            "4.1": "Diana",
            "5.1": "Dalimil",
            "6.1": "T≈ôi kr√°lov√©",
            "7.1": "Vilma",
            "8.1": "ƒåestm√≠r",
            "9.1": "Vladan",
            "10.1": "B≈ôetislav",
            "11.1": "Bohdana",
            "12.1": "Pravoslav",
            "13.1": "Edita",
            "14.1": "Radovan",
            "15.1": "Alice",
            "16.1": "Ctirad",
            "17.1": "Drahoslav",
            "18.1": "Vladislav",
            "19.1": "Doubravka",
            "20.1": "Ilona",
            "21.1": "Bƒõla",
            "22.1": "Slavom√≠r",
            "23.1": "Zdenƒõk",
            "24.1": "Milena",
            "25.1": "Milo≈°",
            "26.1": "Zora",
            "27.1": "Ingrid",
            "28.1": "Ot√Ωlie",
            "29.1": "Zdislava",
            "30.1": "Robin",
            "31.1": "Marika",
            "1.2": "Hynek",
            "2.2": "Nela",
            "3.2": "Bla≈æej",
            "4.2": "Jarmila",
            "5.2": "Dobromila",
            "6.2": "Vanda",
            "7.2": "Veronika",
            "8.2": "Milada",
            "9.2": "Apolena",
            "10.2": "Mojm√≠r",
            "11.2": "Bo≈æena",
            "12.2": "Slavƒõna",
            "13.2": "Vƒõnceslav",
            "14.2": "Valent√Ωn",
            "15.2": "Ji≈ôina",
            "16.2": "Ljuba",
            "17.2": "Miloslava",
            "18.2": "Gizela",
            "19.2": "Patrik",
            "20.2": "Old≈ôich",
            "21.2": "Lenka",
            "22.2": "Petr",
            "23.2": "Svatopluk",
            "24.2": "Matƒõj",
            "25.2": "Liliana",
            "26.2": "Dorota",
            "27.2": "Alexandr",
            "28.2": "Lum√≠r",
            "29.2": "Horym√≠r",
            "1.3": "Bed≈ôich",
            "2.3": "Ane≈æka",
            "3.3": "Kamil",
            "4.3": "Stela",
            "5.3": "Kazim√≠r",
            "6.3": "Miroslav",
            "7.3": "Tom√°≈°",
            "8.3": "Gabriela",
            "9.3": "Franti≈°ka",
            "10.3": "Viktorie",
            "11.3": "Andƒõla",
            "12.3": "≈òeho≈ô",
            "13.3": "R≈Ø≈æena",
            "14.3": "R√∫t",
            "15.3": "Ida",
            "16.3": "Elena",
            "17.3": "Vlastimil",
            "18.3": "Eduard",
            "19.3": "Josef",
            "20.3": "Svƒõtlana",
            "21.3": "Radek",
            "22.3": "Leona",
            "23.3": "Ivona",
            "24.3": "Gabriel",
            "25.3": "Mari√°n",
            "26.3": "Emanuel",
            "27.3": "Dita",
            "28.3": "So≈àa",
            "29.3": "Ta≈•√°na",
            "30.3": "Arno≈°t",
            "31.3": "Kvido",
            "1.4": "Hugo",
            "2.4": "Erika",
            "3.4": "Richard",
            "4.4": "Ivana",
            "5.4": "Miroslava",
            "6.4": "Vendula",
            "7.4": "He≈ôman",
            "8.4": "Ema",
            "9.4": "Du≈°an",
            "10.4": "Darja",
            "11.4": "Izabela",
            "12.4": "Julius",
            "13.4": "Ale≈°",
            "14.4": "Vincent",
            "15.4": "Anast√°zie",
            "16.4": "Irena",
            "17.4": "Rudolf",
            "18.4": "Val√©rie",
            "19.4": "Rostislav",
            "20.4": "Marcela",
            "21.4": "Alexandra",
            "22.4": "Ev≈æenie",
            "23.4": "Vojtƒõch",
            "24.4": "Ji≈ô√≠",
            "25.4": "Marek",
            "26.4": "Oto",
            "27.4": "Jaroslav",
            "28.4": "Vlastislav",
            "29.4": "Robert",
            "30.4": "Blahoslav",
            "1.5": "Sv√°tek pr√°ce",
            "2.5": "Zikmund",
            "3.5": "Alexej",
            "4.5": "Kvƒõtoslav",
            "5.5": "Klaudie",
            "6.5": "Radoslav",
            "7.5": "Stanislav",
            "8.5": "Den osvobozen√≠",
            "9.5": "Ctibor",
            "10.5": "Bla≈æena",
            "11.5": "Svatava",
            "12.5": "Pankr√°c",
            "13.5": "Serv√°c",
            "14.5": "Bonif√°c",
            "15.5": "≈Ωofie",
            "16.5": "P≈ôemysl",
            "17.5": "Aneta",
            "18.5": "Nata≈°a",
            "19.5": "Ivo",
            "20.5": "Zby≈°ek",
            "21.5": "Monika",
            "22.5": "Emil",
            "23.5": "Vladim√≠r",
            "24.5": "Jana",
            "25.5": "Viola",
            "26.5": "Filip",
            "27.5": "Valdemar",
            "28.5": "Vil√©m",
            "29.5": "Maxmili√°n",
            "30.5": "Ferdinand",
            "31.5": "Kamila",
            "1.6": "Laura",
            "2.6": "Jarmil",
            "3.6": "Tamara",
            "4.6": "Dalibor",
            "5.6": "Dobroslav",
            "6.6": "Norbert",
            "7.6": "Iveta",
            "8.6": "Medard",
            "9.6": "Stanislava",
            "10.6": "Gita",
            "11.6": "Bruno",
            "12.6": "Antonie",
            "13.6": "Anton√≠n",
            "14.6": "Roland",
            "15.6": "V√≠t",
            "16.6": "Zbynƒõk",
            "17.6": "Adolf",
            "18.6": "Milan",
            "19.6": "Leo≈°",
            "20.6": "Kvƒõta",
            "21.6": "Alois",
            "22.6": "Pavla",
            "23.6": "Zde≈àka",
            "24.6": "Jan",
            "25.6": "Ivan",
            "26.6": "Adriana",
            "27.6": "Ladislav",
            "28.6": "Lubom√≠r",
            "29.6": "Petr a Pavel",
            "30.6": "≈†√°rka",
            "1.7": "Jaroslava",
            "2.7": "Patricie",
            "3.7": "Radom√≠r",
            "4.7": "Prokop",
            "5.7": "Cyril a Metodƒõj",
            "6.7": "Jan Hus",
            "7.7": "Bohuslava",
            "8.7": "Nora",
            "9.7": "Drahoslava",
            "10.7": "Libu≈°e",
            "11.7": "Olga",
            "12.7": "Bo≈ôek",
            "13.7": "Mark√©ta",
            "14.7": "Karol√≠na",
            "15.7": "Jind≈ôich",
            "16.7": "Lubo≈°",
            "17.7": "Martina",
            "18.7": "Drahom√≠ra",
            "19.7": "ƒåenƒõk",
            "20.7": "Ilja",
            "21.7": "V√≠tƒõzslav",
            "22.7": "Magdal√©na",
            "23.7": "Libor",
            "24.7": "Krist√Ωna",
            "25.7": "Jakub",
            "26.7": "Anna",
            "27.7": "Vƒõroslav",
            "28.7": "Viktor",
            "29.7": "Marta",
            "30.7": "Bo≈ôivoj",
            "31.7": "Ign√°c",
            "1.8": "Oskar",
            "2.8": "Gustav",
            "3.8": "Milu≈°e",
            "4.8": "Dominik",
            "5.8": "Kristi√°n",
            "6.8": "Old≈ôi≈°ka",
            "7.8": "Lada",
            "8.8": "Sobƒõslav",
            "9.8": "Roman",
            "10.8": "Vav≈ôinec",
            "11.8": "Zuzana",
            "12.8": "Kl√°ra",
            "13.8": "Alena",
            "14.8": "Alan",
            "15.8": "Hana",
            "16.8": "J√°chym",
            "17.8": "Petra",
            "18.8": "Helena",
            "19.8": "Ludv√≠k",
            "20.8": "Bernard",
            "21.8": "Johana",
            "22.8": "Bohuslav",
            "23.8": "Sandra",
            "24.8": "Bartolomƒõj",
            "25.8": "Radim",
            "26.8": "Ludƒõk",
            "27.8": "Otakar",
            "28.8": "August√Ωn",
            "29.8": "Evel√≠na",
            "30.8": "Vladƒõna",
            "31.8": "Pavl√≠na",
            "1.9": "Linda",
            "2.9": "Ad√©la",
            "3.9": "Bronislav",
            "4.9": "Jind≈ôi≈°ka",
            "5.9": "Boris",
            "6.9": "Boleslav",
            "7.9": "Reg√≠na",
            "8.9": "Mariana",
            "9.9": "Daniela",
            "10.9": "Irma",
            "11.9": "Denisa",
            "12.9": "Marie",
            "13.9": "Lubor",
            "14.9": "Radka",
            "15.9": "Jolana",
            "16.9": "Ludmila",
            "17.9": "Nadƒõ≈æda",
            "18.9": "Kry≈°tof",
            "19.9": "Zita",
            "20.9": "Oleg",
            "21.9": "Matou≈°",
            "22.9": "Darina",
            "23.9": "Berta",
            "24.9": "Jarom√≠r",
            "25.9": "Zlata",
            "26.9": "Andrea",
            "27.9": "Jon√°≈°",
            "28.9": "V√°clav",
            "29.9": "Michal",
            "30.9": "Jeron√Ωm",
            "1.10": "Igor",
            "2.10": "Ol√≠vie",
            "3.10": "Bohumil",
            "4.10": "Franti≈°ek",
            "5.10": "Eli≈°ka",
            "6.10": "Hanu≈°",
            "7.10": "Just√Ωna",
            "8.10": "Vƒõra",
            "9.10": "≈†tefan",
            "10.10": "Marina",
            "11.10": "Andrej",
            "12.10": "Marcel",
            "13.10": "Ren√°ta",
            "14.10": "Ag√°ta",
            "15.10": "Tereza",
            "16.10": "Havel",
            "17.10": "Hedvika",
            "18.10": "Luk√°≈°",
            "19.10": "Michaela",
            "20.10": "Vendel√≠n",
            "21.10": "Brigita",
            "22.10": "Sabina",
            "23.10": "Teodor",
            "24.10": "Nina",
            "25.10": "Be√°ta",
            "26.10": "Erik",
            "27.10": "≈†arlota",
            "28.10": "Den vzniku ƒåSR",
            "29.10": "Silvie",
            "30.10": "Tade√°≈°",
            "31.10": "≈†tƒõp√°nka",
            "1.11": "Felix",
            "2.11": "Pam√°tka zesnul√Ωch",
            "3.11": "Hubert",
            "4.11": "Karel",
            "5.11": "Miriam",
            "6.11": "Libƒõna",
            "7.11": "Saskie",
            "8.11": "Bohum√≠r",
            "9.11": "Bohdan",
            "10.11": "Ev≈æen",
            "11.11": "Martin",
            "12.11": "Benedikt",
            "13.11": "Tibor",
            "14.11": "S√°va",
            "15.11": "Leopold",
            "16.11": "Otmar",
            "17.11": "Den boje za svobodu",
            "18.11": "Romana",
            "19.11": "Al≈æbƒõta",
            "20.11": "Nikola",
            "21.11": "Albert",
            "22.11": "Cec√≠lie",
            "23.11": "Klement",
            "24.11": "Em√≠lie",
            "25.11": "Kate≈ôina",
            "26.11": "Artur",
            "27.11": "Xenie",
            "28.11": "Ren√©",
            "29.11": "Zina",
            "30.11": "Ond≈ôej",
            "1.12": "Iva",
            "2.12": "Blanka",
            "3.12": "Svatoslav",
            "4.12": "Barbora",
            "5.12": "Jitka",
            "6.12": "Mikul√°≈°",
            "7.12": "Ambro≈æ",
            "8.12": "Kvƒõtoslava",
            "9.12": "Vratislav",
            "10.12": "Julie",
            "11.12": "Dana",
            "12.12": "Simona",
            "13.12": "Lucie",
            "14.12": "L√Ωdie",
            "15.12": "Radana",
            "16.12": "Alb√≠na",
            "17.12": "Daniel",
            "18.12": "Miloslav",
            "19.12": "Ester",
            "20.12": "Dagmar",
            "21.12": "Nat√°lie",
            "22.12": "≈†imon",
            "23.12": "Vlasta",
            "24.12": "Adam a Eva",
            "25.12": "1. sv√°tek v√°noƒçn√≠",
            "26.12": "≈†tƒõp√°n",
            "27.12": "≈Ωaneta",
            "28.12": "Bohumila",
            "29.12": "Judita",
            "30.12": "David",
            "31.12": "Silvestr"
        };
        
        // Admin RFID karta - POUZE p≈ôesn√© hodnoty z bezpeƒçnostn√≠ch d≈Øvod≈Ø
        const ADMIN_RFID = '0046584111';    // Pln√° hodnota s nulou
        const ADMIN_RFID_ALT = '46584111';  // Bez poƒç√°teƒçn√≠ nuly
        // BEZPEƒåNOSTN√ç POZN√ÅMKA: Prefix byl odstranƒõn kv≈Øli bezpeƒçnostn√≠ chybƒõ - nelze pou≈æ√≠t ƒç√°steƒçn√© porovn√°n√≠
        
        // ===== Funkce pro aktualizaci ƒçasu, data a sv√°tk≈Ø =====
        
        // Funkce pro aktualizaci aktu√°ln√≠ho ƒçasu
        function updateCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            // Form√°t: HH:MM:SS
            const timeString = `${hours}:${minutes}:${seconds}`;
            
            // Aktualizace ƒçasu na str√°nce
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
            
            // Opakov√°n√≠ ka≈ædou sekundu
            setTimeout(updateCurrentTime, 1000);
        }
        
        // Funkce pro aktualizaci aktu√°ln√≠ho data a sv√°tku
        function updateDateAndNameDay() {
            const now = new Date();
            const day = now.getDate();
            const month = now.getMonth() + 1; // Mƒõs√≠ce jsou indexov√°ny od 0
            const year = now.getFullYear();
            
            // Form√°t: D.M.YYYY
            const dateString = `${day}.${month}.${year}`;
            
            // Aktualizace data na str√°nce
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = dateString;
            }
            
            // Zji≈°tƒõn√≠, kdo m√° dnes sv√°tek
            const nameDayKey = `${day}.${month}`;
            const nameDay = czechNameDays[nameDayKey] || "Nezn√°m√Ω sv√°tek";
            
            // Aktualizace sv√°tku na str√°nce
            const nameDayElement = document.getElementById('nameDay');
            if (nameDayElement) {
                nameDayElement.textContent = `Sv√°tek m√°: ${nameDay}`;
            }
        }
        
        // Funkce pro naƒçten√≠ a zobrazen√≠ stavu pokladny
        async function updateCashRegisterStatus() {
            try {
                const { data, error } = await supabaseClient
                    .from('cash_register')
                    .select('amount')
                    .order('last_updated', { ascending: false })
                    .limit(1)
                    .single();
                
                if (error) throw error;
                
                // Aktualizace stavu pokladny na str√°nce
                const cashRegisterElement = document.getElementById('cashRegisterStatus');
                if (cashRegisterElement && data) {
                    cashRegisterElement.textContent = `${data.amount} Kƒç`;
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ stavu pokladny:', error);
                const cashRegisterElement = document.getElementById('cashRegisterStatus');
                if (cashRegisterElement) {
                    cashRegisterElement.textContent = "Chyba naƒç√≠t√°n√≠";
                }
            }
        }
        
        // Event Listeners p≈ôi naƒçten√≠ dokumentu
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializace UI
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginScreen').classList.add('fade-in');
                document.getElementById('rfidInput').focus();
                
                // Spu≈°tƒõn√≠ aktualizace ƒçasu, data a sv√°tku
                updateCurrentTime();
                updateDateAndNameDay();
                updateCashRegisterStatus();
                startCashRegisterUpdates();
                
                // Spu≈°tƒõn√≠ pl√°novaƒçe pro mƒõs√≠ƒçn√≠ reporty
                scheduleMonthlyReportCheck();
                console.log('Pl√°novaƒç mƒõs√≠ƒçn√≠ch report≈Ø spu≈°tƒõn');
            }, 1000);
            
            // RFID Input Handler
            document.getElementById('rfidInput').addEventListener('input', handleRfidInput);
            
            // NFC Login Button
            document.getElementById('nfcLoginBtn').addEventListener('click', startNFCLogin);
            
            // Biometric Login Button
            document.getElementById('biometricLoginBtn').addEventListener('click', startBiometricLogin);
            
            // P≈ôid√°n√≠ event listener≈Ø pro mƒõs√≠ƒçn√≠ reporty
            document.getElementById('sendMonthlyReportBtn').addEventListener('click', () => {
                console.log('Testov√°n√≠ odesl√°n√≠ mƒõs√≠ƒçn√≠ch report≈Ø');
                // Vol√°n√≠ funkce v testovac√≠m re≈æimu (true)
                sendMonthlyReportsToAllUsers(true);
            });
            
            // P≈ôid√°n√≠ event listener≈Ø pro maz√°n√≠ historie transakc√≠
            document.getElementById('clearHistoryBtn').addEventListener('click', showFirstConfirmModal);
            document.getElementById('cancelFirstConfirmBtn').addEventListener('click', hideFirstConfirmModal);
            document.getElementById('cancelSecondConfirmBtn').addEventListener('click', hideSecondConfirmModal);
            document.getElementById('firstConfirmAdminRfid').addEventListener('input', handleFirstConfirmRfid);
            document.getElementById('secondConfirmAdminRfid').addEventListener('input', handleSecondConfirmRfid);
            
            // Admin RFID Input Handler - s lep≈°√≠ podporou pro postupn√© zad√°v√°n√≠
            const adminInput = document.getElementById('adminRfidInput');
            if (adminInput) {
                // Kumulativn√≠ promƒõnn√° pro postupn√© zad√°v√°n√≠ znak≈Ø
                let adminInputBuffer = '';
                
                // M√≠sto input ud√°losti, kter√° m≈Ø≈æe p≈ôi rychl√©m zad√°v√°n√≠ nefungovat spr√°vnƒõ,
                // pou≈æijeme keydown, kter√° zachyt√≠ ka≈ædou kl√°vesu
                adminInput.addEventListener('keydown', (event) => {
                    // Logujeme ka≈ædou kl√°vesu pro diagnostiku
                    console.log('Admin input keydown:', event.key, event.keyCode);
                    
                    // Ignorujeme speci√°ln√≠ kl√°vesy
                    if (event.key.length === 1) {
                        // P≈ôid√°me znak do bufferu
                        adminInputBuffer += event.key;
                        console.log('Admin input buffer:', adminInputBuffer);
                        
                        // BEZPEƒåN√Å kontrola - buffer mus√≠ b√Ωt p≈ôesnƒõ roven admin kartƒõ
                        // Pou≈æ√≠v√°me endsWith pro p≈ô√≠pad, ≈æe buffer obsahuje dal≈°√≠ znaky na zaƒç√°tku
                        if (adminInputBuffer.endsWith('0046584111') || 
                            adminInputBuffer.endsWith('46584111') ||
                            adminInputBuffer === '0046584111' ||
                            adminInputBuffer === '46584111') {
                            console.log('*** ADMIN RFID KARTA DETEKOV√ÅNA V BUFFERU (p≈ôesn√° shoda) ***');
                            // Nastav√≠me admin m√≥d
                            adminMode = true;
                            // Skryjeme admin dialog
                            document.getElementById('adminRfidPrompt').classList.add('hidden');
                            // Vyƒçist√≠me vstupn√≠ pole a buffer
                            document.getElementById('adminRfidInput').value = '';
                            adminInputBuffer = '';
                            // Zobraz√≠me admin panel
                            document.getElementById('loginScreen').classList.add('hidden');
                            document.getElementById('adminPanel').classList.remove('hidden');
                            document.getElementById('adminPanel').classList.add('fade-in');
                            // Naƒçteme admin data
                            loadUsers();
                            loadAllTransactions();
                            loadCashRegisterAmount(); // Naƒçten√≠ stavu pokladny
                            // Zobraz√≠me potvrzovac√≠ zpr√°vu
                            showToast('‚úÖ', 'Admin p≈ô√≠stup', 'P≈ôihl√°≈°en√≠ do admin sekce √∫spƒõ≈°n√©', 'success');
                        }
                    }
                });
                
                // Zachov√°me p≈Øvodn√≠ input handler pro kompatibilitu
                adminInput.addEventListener('input', handleAdminRfidInput);
            } else {
                console.error('Element adminRfidInput nenalezen p≈ôi inicializaci!');
            }
            
            // Admin Login
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            if (adminLoginBtn) {
                adminLoginBtn.addEventListener('click', (event) => {
                    event.preventDefault(); // Zabr√°n√≠me v√Ωchoz√≠mu chov√°n√≠
                    console.log('Kliknuto na Admin p≈ô√≠stup');
                    showAdminRfidPrompt();
                });
            } else {
                console.error('Element adminLoginBtn nenalezen!');
            }
            
            const cancelAdminBtn = document.getElementById('cancelAdminBtn');
            if (cancelAdminBtn) {
                cancelAdminBtn.addEventListener('click', (event) => {
                    event.preventDefault(); // Zabr√°n√≠me v√Ωchoz√≠mu chov√°n√≠
                    console.log('Kliknuto na Zru≈°it v admin promptu');
                    hideAdminRfidPrompt();
                });
            } else {
                console.error('Element cancelAdminBtn nenalezen!');
            }
            
            // Tlaƒç√≠tko pro manu√°ln√≠ zad√°n√≠ admin karty
            const manualAdminBtn = document.getElementById('manualAdminBtn');
            if (manualAdminBtn) {
                manualAdminBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    console.log('Kliknuto na Zadat ruƒçnƒõ');
                    // P≈ô√≠mo vlo≈æ√≠me admin kartu do inputu
                    const adminInput = document.getElementById('adminRfidInput');
                    if (adminInput) {
                        adminInput.value = ADMIN_RFID;
                        // Simulujeme ud√°lost input, aby se aktivoval handler
                        const inputEvent = new Event('input', { bubbles: true });
                        adminInput.dispatchEvent(inputEvent);
                    }
                });
            } else {
                console.error('Element manualAdminBtn nenalezen!');
            }
            
            // Odhl√°≈°en√≠
            document.getElementById('userLogoutBtn').addEventListener('click', handleLogout);
            document.getElementById('adminLogoutBtn').addEventListener('click', handleLogout);
            
            // User Management
            document.getElementById('addUserBtn').addEventListener('click', showAddUserModal);
            document.getElementById('cancelUserBtn').addEventListener('click', hideUserModal);
            document.getElementById('userForm').addEventListener('submit', handleSaveUser);
            
            // Credit Management
            document.getElementById('creditForm').addEventListener('submit', handleAddCredit);
            
            // Delete User
            document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleConfirmDelete);
            
            // Order Management
            document.getElementById('cancelOrderBtn').addEventListener('click', hideOrderModal);
            document.getElementById('confirmOrderBtn').addEventListener('click', handleConfirmOrder);
            
            // Zav≈ô√≠t toast
            document.getElementById('closeToastBtn').addEventListener('click', () => {
                document.getElementById('toast').classList.add('hidden');
            });
            
            // P≈ôid√°n√≠ event listener≈Ø pro tlaƒç√≠tka objedn√°vek
            document.querySelectorAll('.coffee-button').forEach(button => {
                button.addEventListener('click', handleOrderClick);
            });
            
            // Obsluha formul√°≈ôe pokladny
            document.getElementById('cashRegisterForm').addEventListener('submit', handleCashRegisterUpdate);
        });
        
        // ===== RFID a P≈ôihla≈°ov√°n√≠ =====
        
        // Zpracov√°n√≠ vstupu z RFID ƒçteƒçky
        function handleRfidInput(event) {
            const rfidValue = event.target.value;
            
            // Pokud je d√©lka RFID karty alespo≈à 10 znak≈Ø, zkus√≠me p≈ôihl√°sit u≈æivatele
            if (rfidValue.length >= 10) {
                handleCardLogin(rfidValue, 'RFID');
            }
        }
        
        // Zpracov√°n√≠ admin RFID vstupu - zcela p≈ôepracov√°no s podporou pro postupn√© zad√°v√°n√≠
        function handleAdminRfidInput(event) {
            const rfidValue = event.target.value.trim();
            
            // Podrobn√© logov√°n√≠ pro diagnostiku
            console.log('Admin RFID input:', rfidValue);
            console.log('Admin RFID oƒçek√°v√°no:', ADMIN_RFID, 'nebo', ADMIN_RFID_ALT);
            console.log('D√©lka vstupu:', rfidValue.length);
            
            // BEZPEƒåN√Å IMPLEMENTACE:
            // Detekce admin karty - POUZE p≈ôesn√© porovn√°n√≠ cel√Ωch hodnot z bezpeƒçnostn√≠ch d≈Øvod≈Ø
            // Mus√≠ b√Ωt zad√°no cel√© 10m√≠stn√© ƒç√≠slo karty pro admin p≈ô√≠stup
            if (rfidValue.length >= 10) {
                // BEZPEƒåN√â porovn√°n√≠ - pouze p≈ôesn√© shody s kompletn√≠mi admin kartami
                // Odstranƒõno ƒç√°steƒçn√© porovn√°n√≠ kv≈Øli bezpeƒçnostn√≠ chybƒõ
                if (rfidValue === ADMIN_RFID || rfidValue === ADMIN_RFID_ALT) {
                    console.log('*** ADMIN RFID KARTA √öSPƒö≈†Nƒö OVƒö≈òENA (p≈ôesn√° shoda) ***');
                    // Nastav√≠me admin m√≥d
                    adminMode = true;
                    // Skryjeme admin dialog
                    document.getElementById('adminRfidPrompt').classList.add('hidden');
                    // Vyƒçist√≠me vstupn√≠ pole
                    document.getElementById('adminRfidInput').value = '';
                    // Zobraz√≠me admin panel
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    document.getElementById('adminPanel').classList.add('fade-in');
                    // Naƒçteme admin data
                    loadUsers();
                    loadAllTransactions();
                    // Zobraz√≠me potvrzovac√≠ zpr√°vu
                    showToast('‚úÖ', 'Admin p≈ô√≠stup', 'P≈ôihl√°≈°en√≠ do admin sekce √∫spƒõ≈°n√©', 'success');
                    return;
                }
                
                // Kontrola, zda jsme ji≈æ zadali dostatek znak≈Ø pro ƒç√°steƒçn√© ovƒõ≈ôen√≠,
                // ale ƒç√≠slo st√°le nebylo rozpozn√°no jako admin karta
                if (rfidValue.length >= 10) {
                    console.log('Nespr√°vn√° admin karta:', rfidValue);
                    // Zobrazit chybu v admin promptu
                    const adminError = document.getElementById('adminLoginError');
                    if (adminError) {
                        adminError.textContent = 'Nespr√°vn√° admin karta';
                        adminError.classList.remove('hidden');
                        
                        setTimeout(() => {
                            adminError.classList.add('hidden');
                        }, 3000);
                    } else {
                        console.error('Element adminLoginError nenalezen!');
                    }
                    
                    // Vyƒçist√≠me vstupn√≠ pole
                    document.getElementById('adminRfidInput').value = '';
                }
            }
        }
        
        // Zobrazen√≠ admin RFID promptu
        function showAdminRfidPrompt() {
            console.log('Zobrazuji admin RFID prompt');
            const adminPrompt = document.getElementById('adminRfidPrompt');
            if (adminPrompt) {
                adminPrompt.classList.remove('hidden');
                // Poƒçk√°me 100ms p≈ôed zamƒõ≈ôen√≠m, aby se prvek stihl zobrazit
                setTimeout(() => {
                    const adminInput = document.getElementById('adminRfidInput');
                    if (adminInput) {
                        adminInput.value = ''; // Vyƒçist√≠me p≈ô√≠padnou p≈ôedchoz√≠ hodnotu
                        adminInput.focus();
                        console.log('Admin input zamƒõ≈ôen');
                    } else {
                        console.error('Element adminRfidInput nenalezen!');
                    }
                }, 100);
            } else {
                console.error('Element adminRfidPrompt nenalezen!');
            }
        }
        
        // Skryt√≠ admin RFID promptu
        function hideAdminRfidPrompt() {
            console.log('Skr√Ωv√°m admin RFID prompt');
            const adminPrompt = document.getElementById('adminRfidPrompt');
            if (adminPrompt) {
                adminPrompt.classList.add('hidden');
                const adminInput = document.getElementById('adminRfidInput');
                if (adminInput) {
                    adminInput.value = '';
                }
            } else {
                console.error('Element adminRfidPrompt nenalezen!');
            }
        }
        
        // P≈ôihl√°≈°en√≠ u≈æivatele pomoc√≠ RFID karty
        async function loginWithRfid(rfidCard) {
            rfidCard = rfidCard.trim();
            console.log('RFID input:', rfidCard);
            
            // Kontrola minim√°ln√≠ d√©lky karty
            if (rfidCard.length < 10) {
                console.log('RFID karta je p≈ô√≠li≈° kr√°tk√°:', rfidCard.length);
                showLoginError('Neplatn√° RFID karta - p≈ô√≠li≈° kr√°tk√°');
                document.getElementById('rfidInput').value = '';
                return;
            }
            
            try {
                // Odstranƒõno speci√°ln√≠ zpracov√°n√≠ admin karty - bude se p≈ôihla≈°ovat jako bƒõ≈æn√Ω u≈æivatel
                
                // Standardn√≠ zpracov√°n√≠ pro ostatn√≠ karty - pou≈æijeme single(), kter√Ω vr√°t√≠ chybu,
                // pokud karta neexistuje
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('rfid_card_id', rfidCard)
                    .single();
                
                if (error) {
                    // Rozli≈°en√≠ typu chyby
                    if (error.code === 'PGRST116') {
                        // K√≥d PGRST116 znamen√° "Nebyl nalezen ≈æ√°dn√Ω ≈ô√°dek"
                        console.log('Karta nen√≠ v datab√°zi, p≈ôihla≈°ov√°n√≠ jako HOST');
                        
                        // Naƒçten√≠ HOST √∫ƒçtu
                        const { data: hostData, error: hostError } = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('name', 'HOST')
                            .single();
                        
                        if (hostError) {
                            console.error('Chyba p≈ôi naƒç√≠t√°n√≠ HOST √∫ƒçtu:', hostError);
                            showLoginError('Nepoda≈ôilo se p≈ôihl√°sit jako HOST');
                            document.getElementById('rfidInput').value = '';
                            return;
                        }
                        
                        // P≈ôid√°me informaci o pou≈æit√© kartƒõ (jen pro zobrazen√≠ v UI)
                        hostData.guest_card = rfidCard;
                        
                        // P≈ôihl√°s√≠me jako HOST
                        currentUser = hostData;
                        showUserDashboard(currentUser);
                        
                        // Zobraz√≠me informaci o p≈ôihl√°≈°en√≠ jako HOST
                        showToast('‚ÑπÔ∏è', 'P≈ôihl√°≈°eno jako HOST', 'Pou≈æ√≠v√°te √∫ƒçet pro n√°v≈°tƒõvy', 'info');
                        return;
                    } else {
                        // Jin√Ω typ chyby - skuteƒçn√° chyba datab√°ze
                        console.error('Datab√°zov√° chyba:', error);
                        showLoginError('Chyba p≈ôi p≈ôihla≈°ov√°n√≠');
                        document.getElementById('rfidInput').value = '';
                        return;
                    }
                }
                
                // Karta byla nalezena - standardn√≠ p≈ôihl√°≈°en√≠
                console.log('Nalezen u≈æivatel:', data.name);
                currentUser = data;
                showUserDashboard(currentUser);
                
            } catch (error) {
                console.error('Neoƒçek√°van√° chyba p≈ôi p≈ôihla≈°ov√°n√≠:', error);
                showLoginError('Nepoda≈ôilo se p≈ôihl√°sit');
                document.getElementById('rfidInput').value = '';
            }
        }
        
        // Funkce pro pravidelnou aktualizaci stavu pokladny
        function startCashRegisterUpdates() {
            // Aktualizace ka≈æd√Ωch 30 sekund
            setInterval(updateCashRegisterStatus, 30000);
        }
        
        // Zobrazen√≠ chybov√© zpr√°vy p≈ôi p≈ôihla≈°ov√°n√≠
        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            loginError.textContent = message;
            loginError.classList.remove('hidden');
            
            setTimeout(() => {
                loginError.classList.add('hidden');
            }, 3000);
        }
        
        // Odhl√°≈°en√≠
        function handleLogout() {
            currentUser = null;
            adminMode = false;
            document.getElementById('userDashboard').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginScreen').classList.add('fade-in');
            document.getElementById('rfidInput').value = '';
            document.getElementById('rfidInput').focus();
            
            // Reset admin prompt
            hideAdminRfidPrompt();
            
            showToast('‚úÖ', 'Odhl√°≈°eno', 'Byli jste √∫spƒõ≈°nƒõ odhl√°≈°eni', 'success');
        }
        
        // ===== Zobrazen√≠ UI =====
        
        // Zobrazen√≠ u≈æivatelsk√©ho dashboardu
        function showUserDashboard(user) {
            // Nastaven√≠ u≈æivatelsk√Ωch dat
            document.getElementById('userDashboardName').textContent = user.name;
            
            // Pokud se jedn√° o hosta s n√°v≈°tƒõvnickou kartou, zobraz√≠me ƒç√≠slo karty
            if (user.name === 'HOST' && user.guest_card) {
                document.getElementById('userDashboardCard').textContent = `Karta n√°v≈°tƒõvy: ${user.guest_card}`;
            } else {
                document.getElementById('userDashboardCard').textContent = `Karta: ${user.rfid_card_id}`;
            }
            
            // Nastaven√≠ z≈Østatku
            const balanceElement = document.getElementById('userDashboardBalance');
            balanceElement.textContent = `${user.balance} Kƒç`;
            balanceElement.className = user.balance >= 0 ? 'text-3xl font-bold balance-positive' : 'text-3xl font-bold balance-negative';
            
            // Zobrazen√≠ e-mailu, pokud je k dispozici
            if (user.email) {
                console.log('U≈æivatel m√° e-mail:', user.email);
            }
            
            // Naƒçten√≠ transakc√≠ u≈æivatele
            loadUserTransactions(user.id);
            
            // Zobrazen√≠ dashboardu
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('userDashboard').classList.remove('hidden');
            document.getElementById('userDashboard').classList.add('fade-in');
        }
        
        // Zobrazen√≠ admin panelu - u≈æ se nepou≈æ√≠v√°, logika p≈ôesunuta p≈ô√≠mo do handleAdminRfidInput
        function showAdminPanel() {
            console.log('Funkce showAdminPanel() je zastaral√°, pou≈æ√≠v√° se p≈ô√≠mo k√≥d v handleAdminRfidInput()');
            // Tato funkce je ponech√°na jen pro zpƒõtnou kompatibilitu
            // Skr√Ωt login, zobrazit admin panel
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('fade-in');
            
            // Reset admin prompt
            hideAdminRfidPrompt();
            
            // Naƒç√≠st data
            loadUsers();
            loadAllTransactions();
            loadCashRegisterAmount(); // Naƒçten√≠ stavu pokladny
        }
        
        // ===== Funkce pro mƒõs√≠ƒçn√≠ reporty =====
        
        // Funkce pro z√≠sk√°n√≠ statistik u≈æivatele za zadan√© obdob√≠
        async function getUserStatsForPeriod(userId, startDate, endDate) {
            try {
                console.log(`Z√≠sk√°v√°n√≠ statistik pro u≈æivatele ${userId} od ${startDate} do ${endDate}`);
                
                // Form√°tov√°n√≠ datum≈Ø pro SQL dotazy
                const startDateStr = startDate.toISOString();
                const endDateStr = endDate.toISOString();
                
                // Z√≠sk√°n√≠ informac√≠ o u≈æivateli
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (userError) throw userError;
                if (!userData) {
                    console.log(`U≈æivatel ${userId} nenalezen`);
                    return null;
                }
                
                console.log(`Nalezen u≈æivatel: ${userData.name}`);
                
                // Poƒçet vypit√Ωch k√°v a celkov√° √∫trata
                const { data: coffeeOrders, error: coffeeError } = await supabaseClient
                    .from('transactions')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('type', 'order')
                    .gte('created_at', startDateStr)
                    .lte('created_at', endDateStr);
                
                if (coffeeError) throw coffeeError;
                
                const coffeeCount = coffeeOrders ? coffeeOrders.length : 0;
                const totalSpent = coffeeOrders ? coffeeOrders.reduce((sum, order) => sum + Number(order.amount), 0) : 0;
                
                console.log(`Poƒçet k√°v: ${coffeeCount}, celkov√° √∫trata: ${totalSpent} Kƒç`);
                
                // Poƒçet dobit√≠ kreditu a celkov√° ƒç√°stka
                const { data: creditTransactions, error: creditError } = await supabaseClient
                    .from('transactions')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('type', 'credit')
                    .gte('created_at', startDateStr)
                    .lte('created_at', endDateStr);
                
                if (creditError) throw creditError;
                
                const creditCount = creditTransactions ? creditTransactions.length : 0;
                const totalCredit = creditTransactions ? creditTransactions.reduce((sum, credit) => sum + Number(credit.amount), 0) : 0;
                
                console.log(`Poƒçet dobit√≠: ${creditCount}, celkov√° ƒç√°stka: ${totalCredit} Kƒç`);
                
                // Z√≠sk√°n√≠ prvn√≠ transakce v obdob√≠ pro zji≈°tƒõn√≠ poƒç√°teƒçn√≠ho z≈Østatku
                const { data: firstTransaction, error: firstTransError } = await supabaseClient
                    .from('transactions')
                    .select('*')
                    .eq('user_id', userId)
                    .gte('created_at', startDateStr)
                    .order('created_at', { ascending: true })
                    .limit(1);
                
                if (firstTransError) throw firstTransError;
                
                // Pokud nejsou ≈æ√°dn√© transakce v obdob√≠, pou≈æijeme aktu√°ln√≠ z≈Østatek jako v√Ωchoz√≠
                let startBalance = userData.balance;
                
                // Pokud jsou transakce, zjist√≠me poƒç√°teƒçn√≠ z≈Østatek odeƒçten√≠m v≈°ech transakc√≠
                if (firstTransaction && firstTransaction.length > 0) {
                    // Z√≠sk√°me v≈°echny transakce v obdob√≠
                    const { data: allTransactions, error: allTransError } = await supabaseClient
                        .from('transactions')
                        .select('*')
                        .eq('user_id', userId)
                        .gte('created_at', startDateStr)
                        .lte('created_at', endDateStr)
                        .order('created_at', { ascending: true });
                    
                    if (allTransError) throw allTransError;
                    
                    if (allTransactions && allTransactions.length > 0) {
                        // Aktu√°ln√≠ z≈Østatek u≈æivatele
                        const currentBalance = userData.balance;
                        
                        // Souƒçet v≈°ech transakc√≠ v obdob√≠ (negativn√≠ hodnoty pro √∫traty, pozitivn√≠ pro dobit√≠)
                        let balanceChange = 0;
                        
                        allTransactions.forEach(transaction => {
                            if (transaction.type === 'order') {
                                // Odeƒçten√≠ √∫traty (hodnota v datab√°zi je kladn√°, pro zmƒõnu z≈Østatku pot≈ôebujeme z√°pornou)
                                balanceChange -= Number(transaction.amount);
                            } else if (transaction.type === 'credit') {
                                // P≈ôiƒçten√≠ dobit√≠
                                balanceChange += Number(transaction.amount);
                            }
                        });
                        
                        // Poƒç√°teƒçn√≠ z≈Østatek = aktu√°ln√≠ z≈Østatek - zmƒõny v obdob√≠
                        startBalance = currentBalance - balanceChange;
                        console.log(`Aktu√°ln√≠ z≈Østatek: ${currentBalance} Kƒç, zmƒõna: ${balanceChange} Kƒç, poƒç√°teƒçn√≠ z≈Østatek: ${startBalance} Kƒç`);
                    }
                }
                
                // Vytvo≈ôen√≠ objektu s v√Ωsledky
                return {
                    user: userData,
                    coffeeCount: coffeeCount,
                    totalSpent: totalSpent,
                    creditCount: creditCount,
                    totalCredit: totalCredit,
                    startBalance: startBalance,
                    endBalance: userData.balance,
                    periodStart: startDate,
                    periodEnd: endDate
                };
                
            } catch (error) {
                console.error('Chyba p≈ôi z√≠sk√°v√°n√≠ statistik u≈æivatele:', error);
                return null;
            }
        }
        
        // Funkce pro odesl√°n√≠ mƒõs√≠ƒçn√≠ho reportu e-mailem
        async function sendMonthlyReportEmail(stats) {
            try {
                if (!stats || !stats.user || !stats.user.email) {
                    console.warn('Nelze odeslat report: chyb√≠ data u≈æivatele nebo e-mail');
                    return false;
                }
                
                // Form√°tov√°n√≠ mƒõs√≠ce a roku - pro p≈ôedchoz√≠ mƒõs√≠c
                const monthNames = ['LEDEN', '√öNOR', 'B≈òEZEN', 'DUBEN', 'KVƒöTEN', 'ƒåERVEN', 'ƒåERVENEC', 'SRPEN', 'Z√Å≈ò√ç', '≈ò√çJEN', 'LISTOPAD', 'PROSINEC'];
                // Pou≈æijeme mƒõs√≠c z periodStart, proto≈æe to je zaƒç√°tek obdob√≠ (prvn√≠ den p≈ôedchoz√≠ho mƒõs√≠ce)
                const monthYear = `${monthNames[stats.periodStart.getMonth()]} ${stats.periodStart.getFullYear()}`;
                
                // Z√≠sk√°n√≠ e-mailu admina a kopie
                const adminEmail = "jan.blazek@sfs.com";
                const coffeeshopEmail = "cofeeshopsfs@gmail.com";
                
                console.log(`Odes√≠l√°n√≠ mƒõs√≠ƒçn√≠ho reportu u≈æivateli ${stats.user.name} na e-mail ${stats.user.email}`);
                
                // Parametry pro EmailJS - pou≈æijeme ≈°ablonu template_ofplxbl pro mƒõs√≠ƒçn√≠ report
                // Form√°t mus√≠ odpov√≠dat ≈°ablonƒõ template_ofplxbl
                const templateParams = {
                    email: stats.user.email,                    // E-mail p≈ô√≠jemce
                    name: stats.user.name,                      // Jm√©no p≈ô√≠jemce
                    month: monthYear,                           // N√°zev mƒõs√≠ce a roku (nap≈ô. "ƒåERVEN 2025")
                    coffee_count: stats.coffeeCount,            // Poƒçet vypit√Ωch k√°v
                    total_spent: stats.totalSpent,              // Celkov√° √∫trata
                    credit_topups: stats.creditCount,           // Poƒçet dobit√≠ kreditu
                    total_credit: stats.totalCredit,            // Celkem dobito
                    start_balance: stats.startBalance.toFixed(2), // Z≈Østatek na zaƒç√°tku mƒõs√≠ce
                    end_balance: stats.endBalance.toFixed(2),   // Aktu√°ln√≠ z≈Østatek
                    reply_to: coffeeshopEmail,                  // E-mail pro odpovƒõƒè
                    cc_email: adminEmail,                       // Kopie e-mailu pro admina
                    from_name: "WEBCofee Automat",              // Jm√©no odes√≠latele
                    from_email: coffeeshopEmail,                // E-mail odes√≠latele
                    subject: 'Mƒõs√≠ƒçn√≠ p≈ôehled' // P≈ôedmƒõt e-mailu
                };
                
                // Odes√≠l√°n√≠ emailu p≈ôes EmailJS - pou≈æijeme ≈°ablonu template_ofplxbl pro mƒõs√≠ƒçn√≠ report
                const response = await emailjs.send(
                    'service_p80izio',                          // Service ID
                    'template_ofplxbl',                         // Spr√°vn√° ≈°ablona pro mƒõs√≠ƒçn√≠ report
                    templateParams
                );
                
                console.log('Mƒõs√≠ƒçn√≠ report √∫spƒõ≈°nƒõ odesl√°n:', response);
                return true;
            } catch (error) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠ mƒõs√≠ƒçn√≠ho reportu:', error);
                return false;
            }
        }
        
        // Funkce pro odesl√°n√≠ report≈Ø v≈°em u≈æivatel≈Øm
        async function sendMonthlyReportsToAllUsers(testMode = false) {
            try {
                // Z√≠sk√°n√≠ v≈°ech u≈æivatel≈Ø s e-mailem
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('id, name, email')
                    .not('email', 'is', null);
                    
                if (error) throw error;
                
                if (!users || users.length === 0) {
                    console.log('≈Ω√°dn√≠ u≈æivatel√© s e-mailem nenalezeni');
                    showToast('‚ö†Ô∏è', 'Upozornƒõn√≠', 'Nenalezeni ≈æ√°dn√≠ u≈æivatel√© s e-mailem', 'warning');
                    return;
                }
                
                // Stanoven√≠ obdob√≠ pro report
                let startDate, endDate;
                
                if (testMode) {
                    // V testovac√≠m re≈æimu pou≈æijeme posledn√≠ch 30 dn√≠
                    endDate = new Date();
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                } else {
                    // V produkƒçn√≠m re≈æimu pou≈æijeme p≈ôedchoz√≠ mƒõs√≠c
                    const today = new Date();
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0); // Posledn√≠ den p≈ôedchoz√≠ho mƒõs√≠ce
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1); // Prvn√≠ den p≈ôedchoz√≠ho mƒõs√≠ce
                }
                
                console.log(`Odes√≠l√°n√≠ mƒõs√≠ƒçn√≠ch report≈Ø ${users.length} u≈æivatel≈Øm za obdob√≠ ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`);
                showToast('‚è≥', 'Zpracov√°n√≠', `Odes√≠l√°n√≠ report≈Ø ${users.length} u≈æivatel≈Øm...`, 'info');
                
                // Poƒç√≠tadlo √∫spƒõ≈°nƒõ odeslan√Ωch report≈Ø
                let successCount = 0;
                
                // Postupn√© odes√≠l√°n√≠ report≈Ø
                for (const user of users) {
                    // Z√≠sk√°n√≠ statistik u≈æivatele
                    const stats = await getUserStatsForPeriod(user.id, startDate, endDate);
                    
                    if (stats) {
                        // Odesl√°n√≠ reportu
                        const success = await sendMonthlyReportEmail(stats);
                        if (success) {
                            successCount++;
                            console.log(`Report √∫spƒõ≈°nƒõ odesl√°n u≈æivateli ${user.name}`);
                        }
                        
                        // Kr√°tk√° pauza mezi odes√≠l√°n√≠m e-mail≈Ø, aby nedo≈°lo k rate limitingu
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // Zobrazen√≠ v√Ωsledku
                if (successCount > 0) {
                    showToast('‚úÖ', '√öspƒõch', `Odesl√°no ${successCount} z ${users.length} report≈Ø`, 'success');
                } else {
                    showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se odeslat ≈æ√°dn√Ω report', 'error');
                }
                
                console.log(`Odes√≠l√°n√≠ report≈Ø dokonƒçeno. √öspƒõ≈°nƒõ odesl√°no: ${successCount} z ${users.length}`);
            } catch (error) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠ mƒõs√≠ƒçn√≠ch report≈Ø:', error);
                showToast('‚ùå', 'Chyba', 'Nastala chyba p≈ôi odes√≠l√°n√≠ report≈Ø', 'error');
            }
        }

        // Funkce pro kontrolu, zda je dnes prvn√≠ den v mƒõs√≠ci
        function isFirstDayOfMonth() {
            const today = new Date();
            return today.getDate() === 1;
        }
        
        // Funkce pro napl√°nov√°n√≠ kontroly posledn√≠ho dne v mƒõs√≠ci
        function scheduleMonthlyReportCheck() {
            const now = new Date();
            // Pl√°nujeme spu≈°tƒõn√≠ v 8:00 r√°no
            const scheduledTime = new Date(
                now.getFullYear(),
                now.getMonth(),
                now.getDate(),
                8, 0, 0, 0 // 8:00:00 r√°no
            );
            
            // Pokud je nyn√≠ po 8:00, napl√°nujeme na z√≠tra
            if (now > scheduledTime) {
                scheduledTime.setDate(scheduledTime.getDate() + 1);
            }
            
            const timeUntilCheck = scheduledTime - now;
            
            setTimeout(() => {
                // Kontrola, zda je prvn√≠ den v mƒõs√≠ci
                if (isFirstDayOfMonth()) {
                    console.log('Dnes je prvn√≠ den v mƒõs√≠ci, odes√≠l√°m reporty za p≈ôedchoz√≠ mƒõs√≠c');
                    sendMonthlyReportsToAllUsers(false); // false = produkƒçn√≠ re≈æim
                }
                
                // Napl√°nov√°n√≠ dal≈°√≠ kontroly
                scheduleMonthlyReportCheck();
            }, timeUntilCheck);
            
            console.log(`Dal≈°√≠ kontrola mƒõs√≠ƒçn√≠ch report≈Ø napl√°nov√°na za ${Math.floor(timeUntilCheck / (1000 * 60 * 60))} hodin`);
        }
        
        // ===== Funkce pro maz√°n√≠ historie transakc√≠ =====
        
        // Funkce pro zobrazen√≠ prvn√≠ho potvrzovac√≠ho okna
        function showFirstConfirmModal() {
            document.getElementById('firstConfirmModal').classList.remove('hidden');
            document.getElementById('firstConfirmAdminRfid').value = '';
            document.getElementById('firstConfirmAdminRfid').focus();
        }
        
        // Funkce pro skryt√≠ prvn√≠ho potvrzovac√≠ho okna
        function hideFirstConfirmModal() {
            document.getElementById('firstConfirmModal').classList.add('hidden');
        }
        
        // Funkce pro zpracov√°n√≠ vstupu prvn√≠ admin karty
        function handleFirstConfirmRfid(event) {
            const rfidValue = event.target.value.trim();
            
            // Kontrola, zda jde o admin kartu
            if (rfidValue === ADMIN_RFID || rfidValue === ADMIN_RFID_ALT) {
                // Skryjeme prvn√≠ mod√°ln√≠ okno
                hideFirstConfirmModal();
                // Zobraz√≠me druh√© mod√°ln√≠ okno
                showSecondConfirmModal();
            }
        }
        
        // Funkce pro zobrazen√≠ druh√©ho potvrzovac√≠ho okna
        function showSecondConfirmModal() {
            document.getElementById('secondConfirmModal').classList.remove('hidden');
            document.getElementById('secondConfirmAdminRfid').value = '';
            document.getElementById('secondConfirmAdminRfid').focus();
        }
        
        // Funkce pro skryt√≠ druh√©ho potvrzovac√≠ho okna
        function hideSecondConfirmModal() {
            document.getElementById('secondConfirmModal').classList.add('hidden');
        }
        
        // Funkce pro zpracov√°n√≠ vstupu druh√© admin karty
        function handleSecondConfirmRfid(event) {
            const rfidValue = event.target.value.trim();
            
            // Kontrola, zda jde o admin kartu
            if (rfidValue === ADMIN_RFID || rfidValue === ADMIN_RFID_ALT) {
                // Skryjeme druh√© mod√°ln√≠ okno
                hideSecondConfirmModal();
                // Provedeme smaz√°n√≠ historie
                clearTransactionHistory();
            }
        }
        
        // Funkce pro smaz√°n√≠ historie transakc√≠
        async function clearTransactionHistory() {
            try {
                // Zobraz√≠me loading indik√°tor
                showToast('‚è≥', 'Prob√≠h√° maz√°n√≠', 'Maz√°n√≠ historie transakc√≠...', 'info');
                
                // Smaz√°n√≠ v≈°ech transakc√≠
                const { error: transactionsError } = await supabaseClient
                    .from('transactions')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // Trik pro smaz√°n√≠ v≈°ech z√°znam≈Ø
                    
                if (transactionsError) throw transactionsError;
                
                // Aktualizace pokladny - zachov√°me aktu√°ln√≠ stav, ale p≈ôid√°me pozn√°mku
                const { data: currentCashRegister } = await supabaseClient
                    .from('cash_register')
                    .select('amount')
                    .order('last_updated', { ascending: false })
                    .limit(1)
                    .single();
                
                // Vlo≈æen√≠ nov√©ho z√°znamu do cash_register s pozn√°mkou o smaz√°n√≠ historie
                await supabaseClient
                    .from('cash_register')
                    .insert({
                        amount: currentCashRegister ? currentCashRegister.amount : 0,
                        note: 'Reset po smaz√°n√≠ historie transakc√≠'
                    });
                
                // Aktualizujeme seznam transakc√≠ v UI
                loadAllTransactions();
                
                // Zobraz√≠me potvrzen√≠
                showToast('‚úÖ', 'Hotovo', 'Historie transakc√≠ byla √∫spƒõ≈°nƒõ smaz√°na', 'success');
            } catch (error) {
                console.error('Chyba p≈ôi maz√°n√≠ historie:', error);
                showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se smazat historii transakc√≠', 'error');
            }
        }
        
        // ===== Funkce pro pokladnu =====
        
        // Naƒçten√≠ aktu√°ln√≠ho stavu pokladny
        async function loadCashRegisterAmount() {
            try {
                const { data, error } = await supabaseClient
                    .from('cash_register')
                    .select('*')
                    .order('last_updated', { ascending: false })
                    .limit(1)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    // Zobrazen√≠ aktu√°ln√≠ho stavu pokladny
                    const amountElement = document.getElementById('cashRegisterAmount');
                    if (amountElement) {
                        amountElement.innerHTML = `${data.amount} Kƒç`;
                    }
                    
                    // Zobrazen√≠ ƒçasu posledn√≠ aktualizace
                    const lastUpdatedElement = document.getElementById('cashRegisterLastUpdated');
                    if (lastUpdatedElement) {
                        const date = new Date(data.last_updated);
                        lastUpdatedElement.textContent = `${date.getDate()}.${date.getMonth()+1}.${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    }
                    
                    // P≈ôedvyplnƒõn√≠ formul√°≈ôe pro aktualizaci
                    const newAmountInput = document.getElementById('cashRegisterNewAmount');
                    if (newAmountInput) {
                        newAmountInput.value = data.amount;
                    }
                } else {
                    // Pokud nen√≠ ≈æ√°dn√Ω z√°znam, zobraz√≠me 0
                    const amountElement = document.getElementById('cashRegisterAmount');
                    if (amountElement) {
                        amountElement.innerHTML = `0 Kƒç`;
                    }
                }
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ stavu pokladny:', error);
                
                // Zobrazen√≠ chyby
                const amountElement = document.getElementById('cashRegisterAmount');
                if (amountElement) {
                    amountElement.innerHTML = `<span style="color: var(--red);">Chyba naƒç√≠t√°n√≠</span>`;
                }
                
                showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se naƒç√≠st stav pokladny', 'error');
            }
        }
        
        // Zpracov√°n√≠ formul√°≈ôe pro aktualizaci stavu pokladny
        async function handleCashRegisterUpdate(event) {
            event.preventDefault();
            
            const newAmount = parseFloat(document.getElementById('cashRegisterNewAmount').value);
            const note = document.getElementById('cashRegisterNote').value.trim() || 'Ruƒçn√≠ aktualizace';
            
            if (isNaN(newAmount) || newAmount < 0) {
                showToast('‚ö†Ô∏è', 'Chyba', 'Zadejte platnou ƒç√°stku (0 nebo v√≠ce)', 'warning');
                return;
            }
            
            try {
                // Nejprve z√≠sk√°me aktu√°ln√≠ stav pokladny
                const { data: currentCashRegisterData, error: currentError } = await supabaseClient
                    .from('cash_register')
                    .select('amount')
                    .order('last_updated', { ascending: false })
                    .limit(1)
                    .single();
                
                if (currentError) throw currentError;
                
                const currentAmount = parseFloat(currentCashRegisterData?.amount || 0);
                const amountChange = newAmount - currentAmount;
                
                // Vlo≈æen√≠ nov√©ho z√°znamu do cash_register
                const { error: registerError } = await supabaseClient
                    .from('cash_register')
                    .insert({
                        amount: newAmount,
                        note: note
                    });
                
                if (registerError) throw registerError;
                
                // Vytvo≈ôen√≠ z√°znamu v tabulce transactions pro evidenci zmƒõny v pokladnƒõ
                const transactionDescription = amountChange >= 0 
                    ? `Nav√Ω≈°en√≠ pokladny o ${amountChange} Kƒç (${note})`
                    : `V√Ωbƒõr z pokladny ${Math.abs(amountChange)} Kƒç (${note})`;
                
                const { error: transactionError } = await supabaseClient
                    .from('transactions')
                    .insert({
                        user_id: null, // Nem√° vazbu na konkr√©tn√≠ho u≈æivatele
                        type: 'cash_register',
                        amount: Math.abs(amountChange), // Ukl√°d√°me absolutn√≠ hodnotu zmƒõny
                        description: transactionDescription
                    });
                
                if (transactionError) throw transactionError;
                
                // Aktualizace zobrazen√©ho stavu pokladny
                loadCashRegisterAmount();
                
                // Aktualizace seznamu transakc√≠
                loadAllTransactions();
                
                // Reset formul√°≈ôe
                document.getElementById('cashRegisterNote').value = '';
                
                showToast('‚úÖ', '√öspƒõch', `Stav pokladny byl aktualizov√°n na ${newAmount} Kƒç`, 'success');
            } catch (error) {
                console.error('Chyba p≈ôi aktualizaci stavu pokladny:', error);
                showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se aktualizovat stav pokladny', 'error');
            }
        }
        
        // ===== Spr√°va u≈æivatel≈Ø =====
        
        // Naƒçten√≠ u≈æivatel≈Ø ze Supabase
        async function loadUsers() {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                // Zobrazit u≈æivatele
                const userListEl = document.getElementById('userList');
                userListEl.innerHTML = '';
                
                // Vyƒçistit select box pro dob√≠jen√≠
                const creditUserSelect = document.getElementById('creditUserId');
                creditUserSelect.innerHTML = '<option value="">Vyberte u≈æivatele...</option>';
                
                if (data && data.length > 0) {
                    data.forEach(user => {
                        const balanceColor = user.balance >= 0 ? 'balance-positive' : 'balance-negative';
                        
                        userListEl.innerHTML += `
                            <div class="operational-block p-3 mb-2 rounded-lg" data-user-id="${user.id}">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <div class="font-bold">üë§ ${user.name}</div>
                                        <div class="text-sm font-medium" style="color: var(--gray);">üîñ RFID: ${user.rfid_card_id}</div>
                                        ${user.nfc_card_id ? `<div class="text-sm font-medium" style="color: var(--gray);">üì± NFC: ${user.nfc_card_id}</div>` : ''}
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="font-bold ${balanceColor}">üí∞ ${user.balance} Kƒç</div>
                                        ${user.biometric_id ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">üëÜ Bio</span>' : ''}
                                        <div class="flex gap-1">
                                            <button 
                                                class="edit-user-btn btn-secondary px-2 py-1 text-xs"
                                                data-id="${user.id}"
                                                title="Upravit">
                                                ‚úèÔ∏è
                                            </button>
                                            ${!user.biometric_id ? 
                                                `<button class="biometric-register-btn btn-primary px-2 py-1 text-xs" data-id="${user.id}" data-name="${user.name}" title="Registrovat biometrick√© ovƒõ≈ôen√≠">üëÜ</button>` : 
                                                `<button class="biometric-remove-btn btn-secondary px-2 py-1 text-xs" data-id="${user.id}" title="Odebrat biometrick√© ovƒõ≈ôen√≠">üóëÔ∏èüëÜ</button>`
                                            }
                                            <button 
                                                class="delete-user-btn btn-danger px-2 py-1 text-xs"
                                                data-id="${user.id}"
                                                data-name="${user.name}"
                                                title="Smazat">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // P≈ôidat u≈æivatele do select boxu pro dob√≠jen√≠
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        creditUserSelect.appendChild(option);
                    });
                    
                    // P≈ôidat event listenery k tlaƒç√≠tk≈Øm
                    document.querySelectorAll('.edit-user-btn').forEach(button => {
                        button.addEventListener('click', () => handleEditUser(button.getAttribute('data-id')));
                    });
                    
                    document.querySelectorAll('.delete-user-btn').forEach(button => {
                        button.addEventListener('click', () => {
                            showDeleteModal(
                                button.getAttribute('data-id'),
                                button.getAttribute('data-name')
                            );
                        });
                    });
                    
                    // Event listenery pro biometrick√© ovƒõ≈ôen√≠
                    document.querySelectorAll('.biometric-register-btn').forEach(button => {
                        button.addEventListener('click', () => {
                            registerBiometric(
                                button.getAttribute('data-id'),
                                button.getAttribute('data-name')
                            );
                        });
                    });
                    
                    document.querySelectorAll('.biometric-remove-btn').forEach(button => {
                        button.addEventListener('click', () => {
                            removeBiometric(button.getAttribute('data-id'));
                        });
                    });
                } else {
                    userListEl.innerHTML = '<p class="text-gray-500 p-3 font-medium">≈Ω√°dn√≠ u≈æivatel√©</p>';
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatel≈Ø:', error);
                showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se naƒç√≠st u≈æivatele', 'error');
            }
        }
        
        // Zobrazen√≠ mod√°ln√≠ho okna pro p≈ôid√°n√≠ u≈æivatele
        function showAddUserModal() {
            // Nastaven√≠ titulku a tlaƒç√≠tka
            document.getElementById('userModalTitle').textContent = 'üë§ P≈ôidat u≈æivatele';
            document.getElementById('saveUserBtn').textContent = '‚úÖ P≈ôidat u≈æivatele';
            
            // Vyƒçi≈°tƒõn√≠ formul√°≈ôe
            document.getElementById('editUserId').value = '';
            document.getElementById('userRfidCard').value = '';
            document.getElementById('userNfcCard').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userBalance').value = '0';
            
            // Zobrazen√≠ mod√°lu
            document.getElementById('userModal').classList.remove('hidden');
        }
        
        // Zobrazen√≠ mod√°ln√≠ho okna pro √∫pravu u≈æivatele
        async function handleEditUser(userId) {
            try {
                // Naƒçten√≠ dat u≈æivatele
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                // Nastaven√≠ titulku a tlaƒç√≠tka
                document.getElementById('userModalTitle').textContent = '‚úèÔ∏è Upravit u≈æivatele';
                document.getElementById('saveUserBtn').textContent = 'üíæ Ulo≈æit zmƒõny';
                
                // Vyplnƒõn√≠ formul√°≈ôe
                document.getElementById('editUserId').value = data.id;
                document.getElementById('userRfidCard').value = data.rfid_card_id || '';
                document.getElementById('userNfcCard').value = data.nfc_card_id || '';
                document.getElementById('userName').value = data.name;
                document.getElementById('userBalance').value = data.balance;
                
                // Zobrazen√≠ mod√°lu
                document.getElementById('userModal').classList.remove('hidden');
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatele:', error);
                showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se naƒç√≠st u≈æivatele', 'error');
            }
        }
        
        // Skryt√≠ mod√°ln√≠ho okna pro p≈ôid√°n√≠/√∫pravu u≈æivatele
        function hideUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }
        
        // Ulo≈æen√≠ u≈æivatele (p≈ôid√°n√≠ nebo √∫prava)
        async function handleSaveUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('editUserId').value;
            const rfidCard = document.getElementById('userRfidCard').value.trim();
            const nfcCard = document.getElementById('userNfcCard').value.trim();
            const name = document.getElementById('userName').value.trim();
            const balance = parseFloat(document.getElementById('userBalance').value);
            
            if (!rfidCard || !name) {
                showToast('‚ö†Ô∏è', 'Chyba', 'Vypl≈àte v≈°echna povinn√° pole', 'warning');
                return;
            }
            
            try {
                let result;
                
                if (userId) {
                    // √öprava existuj√≠c√≠ho u≈æivatele
                    result = await supabaseClient
                        .from('users')
                        .update({
                            rfid_card_id: rfidCard,
                            nfc_card_id: nfcCard || null,
                            name: name,
                            balance: balance,
                            updated_at: new Date()
                        })
                        .eq('id', userId);
                    
                    if (result.error) throw result.error;
                    showToast('‚úÖ', '√öspƒõch', 'U≈æivatel byl √∫spƒõ≈°nƒõ upraven', 'success');
                } else {
                    // Kontrola, zda RFID nebo NFC karta ji≈æ existuje
                    const { data: existingCard } = await supabaseClient
                        .from('users')
                        .select('id')
                        .or(`rfid_card_id.eq.${rfidCard}${nfcCard ? `,nfc_card_id.eq.${nfcCard}` : ''}`)
                        .single();
                    
                    if (existingCard) {
                        showToast('‚ö†Ô∏è', 'Chyba', 'RFID nebo NFC karta ji≈æ existuje', 'warning');
                        return;
                    }
                    
                    // P≈ôid√°n√≠ nov√©ho u≈æivatele
                    result = await supabaseClient
                        .from('users')
                        .insert({
                            rfid_card_id: rfidCard,
                            nfc_card_id: nfcCard || null,
                            name: name,
                            balance: balance
                        });
                    
                    if (result.error) throw result.error;
                    showToast('‚úÖ', '√öspƒõch', 'Nov√Ω u≈æivatel byl √∫spƒõ≈°nƒõ p≈ôid√°n', 'success');
                }
                
                // Skryt√≠ mod√°lu a naƒçten√≠ u≈æivatel≈Ø
                hideUserModal();
                loadUsers();
                
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ u≈æivatele:', error);
                showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se ulo≈æit u≈æivatele', 'error');
            }
        }
        
        // Zobrazen√≠ mod√°ln√≠ho okna pro potvrzen√≠ smaz√°n√≠
        function showDeleteModal(userId, userName) {
            userToDelete = userId;
            document.getElementById('deleteUserName').textContent = `Opravdu chcete smazat u≈æivatele "${userName}"?`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        
        // Skryt√≠ mod√°ln√≠ho okna pro potvrzen√≠ smaz√°n√≠
        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            userToDelete = null;
        }
        
        // Smaz√°n√≠ u≈æivatele
        async function handleConfirmDelete() {
            if (!userToDelete) return;
            
            try {
                // Smaz√°n√≠ u≈æivatele
                const { error } = await supabaseClient
                    .from('users')
                    .delete()
                    .eq('id', userToDelete);
                
                if (error) throw error;
                
                showToast('‚úÖ', '√öspƒõch', 'U≈æivatel byl √∫spƒõ≈°nƒõ smaz√°n', 'success');
                hideDeleteModal();
                loadUsers();
            } catch (error) {
                console.error('Chyba p≈ôi maz√°n√≠ u≈æivatele:', error);
                showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se smazat u≈æivatele', 'error');
            }
        }
        
        // ===== Dob√≠jen√≠ kreditu =====
        
        // Dobit√≠ kreditu
        async function handleAddCredit(event) {
            event.preventDefault();
            
            const userId = document.getElementById('creditUserId').value;
            const amount = parseFloat(document.getElementById('creditAmount').value);
            const description = document.getElementById('creditDescription').value.trim() || 'Dobit√≠ kreditu';
            
            if (!userId || isNaN(amount) || amount <= 0) {
                showToast('‚ö†Ô∏è', 'Chyba', 'Vypl≈àte v≈°echny povinn√© √∫daje', 'warning');
                return;
            }
            
            try {
                // Zji≈°tƒõn√≠ aktu√°ln√≠ho z≈Østatku u≈æivatele
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('balance, name, email')
                    .eq('id', userId)
                    .single();
                
                if (userError) throw userError;
                
                const oldBalance = userData.balance;
                
                // Vytvo≈ôen√≠ transakce pro u≈æivatele
                const { error: transactionError } = await supabaseClient
                    .from('transactions')
                    .insert({
                        user_id: userId,
                        type: 'credit',
                        amount: amount,
                        description: description
                    });
                
                if (transactionError) throw transactionError;
                
                // Naƒçten√≠ aktualizovan√©ho z≈Østatku
                const { data: updatedUser, error: updateError } = await supabaseClient
                    .from('users')
                    .select('balance, name, email')
                    .eq('id', userId)
                    .single();
                
                if (updateError) throw updateError;
                
                // Aktualizace stavu pokladny - zv√Ω≈°en√≠ o ƒç√°stku dobit√≠
                try {
                    // Nejprve naƒçteme aktu√°ln√≠ stav pokladny
                    const { data: cashRegisterData, error: cashRegisterError } = await supabaseClient
                        .from('cash_register')
                        .select('amount')
                        .order('last_updated', { ascending: false })
                        .limit(1)
                        .single();
                    
                    if (cashRegisterError) throw cashRegisterError;
                    
                    const currentAmount = parseFloat(cashRegisterData.amount) || 0;
                    const newAmount = currentAmount + amount;
                    const cashRegisterNote = `Automatick√° aktualizace - dobit√≠ kreditu u≈æivatele ${updatedUser.name} o ${amount} Kƒç`;
                    
                    // Aktualizujeme stav pokladny
                    const { error: updateCashRegisterError } = await supabaseClient
                        .from('cash_register')
                        .insert({
                            amount: newAmount,
                            note: cashRegisterNote
                        });
                    
                    if (updateCashRegisterError) throw updateCashRegisterError;
                    
                    // Vytvo≈ôen√≠ z√°znamu v tabulce transactions pro evidenci zmƒõny v pokladnƒõ
                    const { error: transactionError } = await supabaseClient
                        .from('transactions')
                        .insert({
                            user_id: null, // Nem√° vazbu na konkr√©tn√≠ho u≈æivatele
                            type: 'cash_register',
                            amount: amount, // ƒå√°stka dobit√≠
                            description: `Nav√Ω≈°en√≠ pokladny o ${amount} Kƒç (dobit√≠ kreditu u≈æivatele ${updatedUser.name})`
                        });
                    
                    if (transactionError) throw transactionError;
                    
                    // Aktualizujeme zobrazen√Ω stav pokladny a seznam transakc√≠, pokud je zobrazen
                    loadCashRegisterAmount();
                    loadAllTransactions();
                    
                } catch (cashRegisterError) {
                    console.error('Chyba p≈ôi aktualizaci pokladny:', cashRegisterError);
                    // Nezastavujeme proces dob√≠jen√≠ kv≈Øli chybƒõ pokladny, ale zobraz√≠me varov√°n√≠
                    showToast('‚ö†Ô∏è', 'Varov√°n√≠', 'Kredit byl dobit, ale stav pokladny se nepoda≈ôilo aktualizovat', 'warning');
                }
                
                // Odesl√°n√≠ e-mailu o dobit√≠ kreditu
                try {
                    const emailSent = await sendCreditEmail(
                        updatedUser,               // Data u≈æivatele
                        amount,                    // ƒå√°stka dobit√≠
                        oldBalance,                // P≈Øvodn√≠ z≈Østatek
                        updatedUser.balance        // Nov√Ω z≈Østatek
                    );
                    
                    if (emailSent) {
                        console.log('E-mailov√° notifikace o dobit√≠ odesl√°na');
                    } else {
                        console.warn('E-mailovou notifikaci o dobit√≠ se nepoda≈ôilo odeslat');
                    }
                } catch (emailError) {
                    console.error('Chyba p≈ôi odes√≠l√°n√≠ e-mailu o dobit√≠:', emailError);
                    // Nezastavujeme proces dob√≠jen√≠ kv≈Øli chybƒõ e-mailu
                }
                
                // Reset formul√°≈ôe
                document.getElementById('creditAmount').value = '';
                document.getElementById('creditDescription').value = '';
                
                // Aktualizace seznamu u≈æivatel≈Ø a transakc√≠
                loadUsers();
                loadAllTransactions();
                
                showToast('‚úÖ', '√öspƒõch', `Kredit byl √∫spƒõ≈°nƒõ dobit o ${amount} Kƒç`, 'success');
            } catch (error) {
                console.error('Chyba p≈ôi dob√≠jen√≠ kreditu:', error);
                showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se dob√≠t kredit', 'error');
            }
        }
        
        // ===== Objedn√°vky k√°vy =====
        
        // Kliknut√≠ na tlaƒç√≠tko pro objedn√°n√≠ k√°vy
        function handleOrderClick(event) {
            const button = event.currentTarget;
            const product = button.getAttribute('data-product');
            const price = parseInt(button.getAttribute('data-price'));
            
            if (!currentUser) {
                showToast('‚ö†Ô∏è', 'Chyba', 'Nejste p≈ôihl√°≈°eni', 'warning');
                return;
            }
            
            // Nastaven√≠ dat objedn√°vky
            currentOrder = {
                product: product,
                price: price
            };
            
            // Ulo≈æen√≠ produktu do localStorage pro p≈ô√≠pad ztr√°ty kontextu
            localStorage.setItem('tempOrderProduct', product);
            localStorage.setItem('tempOrderPrice', price.toString());
            
            console.log('Objedn√°vka nastavena:', currentOrder);
            
            // Zobrazen√≠ mod√°lu pro potvrzen√≠ objedn√°vky
            document.getElementById('orderProduct').textContent = product;
            document.getElementById('orderPrice').textContent = price;
            document.getElementById('orderConfirmModal').classList.remove('hidden');
        }
        
        // Skryt√≠ mod√°ln√≠ho okna pro potvrzen√≠ objedn√°vky
        function hideOrderModal() {
            document.getElementById('orderConfirmModal').classList.add('hidden');
            currentOrder = null;
        }
        
        // Funkce pro odesl√°n√≠ e-mailu o objedn√°vce
        async function sendOrderEmail(user, product, price, oldBalance, newBalance) {
            try {
                // Kontrola, zda m√° u≈æivatel e-mail
                if (!user.email) {
                    console.warn('U≈æivatel nem√° e-mail, e-mail nebude odesl√°n');
                    return false;
                }
                
                // Kontrola, zda je produkt definov√°n
                if (!product) {
                    console.warn('Produkt nen√≠ definov√°n, pou≈æijeme v√Ωchoz√≠ hodnotu "k√°va"');
                    product = 'k√°va';
                }
                
                // Z√≠sk√°n√≠ e-mailu admina (Jan Bla≈æek) a kopie pro coffeeshopsfs@gmail.com
                const adminEmail = "jan.blazek@sfs.com";
                const coffeeshopEmail = "cofeeshopsfs@gmail.com";
                
                console.log('Odes√≠l√°n√≠ e-mailu o objedn√°vce pomoc√≠ ≈°ablony template_fdm14kg:', {
                    email: user.email,
                    name: user.name,
                    product: product,
                    price: Math.abs(price),
                    oldBalance: oldBalance,
                    newBalance: newBalance,
                    adminEmail: adminEmail,
                    coffeeshopEmail: coffeeshopEmail
                });
                
                // P≈ô√≠prava aktu√°ln√≠ho data a ƒçasu ve form√°tu DD.MM.YYYY HH:MM
                const now = new Date();
                const formattedDate = `${now.getDate()}.${now.getMonth() + 1}.${now.getFullYear()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                // Parametry pro EmailJS
                const templateParams = {
                    email: user.email,                    // E-mail p≈ô√≠jemce
                    name: user.name,                      // Jm√©no p≈ô√≠jemce
                    customer_name: user.name,             // Jm√©no z√°kazn√≠ka
                    user_email: user.email,               // E-mail z√°kazn√≠ka
                    coffee_name: product,                 // N√°zev k√°vy
                    price: Math.abs(price),               // Cena k√°vy (kladn√° hodnota)
                    old_credit: oldBalance,               // Kredit p≈ôed n√°kupem
                    new_credit: newBalance,               // Kredit po n√°kupu
                    date: formattedDate,                  // Aktu√°ln√≠ datum a ƒças
                    reply_to: coffeeshopEmail,            // E-mail pro odpovƒõƒè - cofeeshopsfs@gmail.com
                    cc_email: adminEmail,                 // Kopie e-mailu pro admina
                    from_name: "WEBCofee Automat",        // Nov√Ω parametr - jm√©no odes√≠latele (m√≠sto Jan Bla≈æek)
                    from_email: coffeeshopEmail           // Nov√Ω parametr - e-mail odes√≠latele
                };
                
                // Odesl√°n√≠ e-mailu s univerz√°ln√≠ ≈°ablonou
                // P≈ôid√°me parametr pro p≈ôedmƒõt e-mailu, aby bylo jasn√©, ≈æe jde o objedn√°vku k√°vy
                templateParams.subject = 'Odbƒõr k√°vy';
                templateParams.email_type = 'order'; // Pro identifikaci typu e-mailu v ≈°ablonƒõ
                
                const response = await emailjs.send(
                    'service_p80izio',                    // Service ID
                    'template_fdm14kg',                   // Template ID - univerz√°ln√≠ ≈°ablona
                    templateParams
                );
                
                console.log('E-mail √∫spƒõ≈°nƒõ odesl√°n:', response);
                return true;
            } catch (error) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠ e-mailu:', error);
                showToast('‚ö†Ô∏è', 'Upozornƒõn√≠', 'E-mailovou notifikaci se nepoda≈ôilo odeslat, ale objedn√°vka byla zpracov√°na', 'warning');
                return false;
            }
        }
        
        // Funkce pro odesl√°n√≠ e-mailu o dobit√≠ kreditu
        async function sendCreditEmail(user, amount, oldBalance, newBalance) {
            try {
                // Kontrola, zda m√° u≈æivatel e-mail
                if (!user.email) {
                    console.warn('U≈æivatel nem√° e-mail, e-mail nebude odesl√°n');
                    return false;
                }
                
                // Z√≠sk√°n√≠ e-mailu admina (Jan Bla≈æek) a kopie pro coffeeshopsfs@gmail.com
                const adminEmail = "jan.blazek@sfs.com";
                const coffeeshopEmail = "cofeeshopsfs@gmail.com";
                
                console.log('Odes√≠l√°n√≠ e-mailu o dobit√≠ pomoc√≠ ≈°ablony template_ofplxbl:', {
                    email: user.email,
                    name: user.name,
                    amount: amount,
                    oldBalance: oldBalance,
                    newBalance: newBalance,
                    adminEmail: adminEmail,
                    coffeeshopEmail: coffeeshopEmail
                });
                
                // P≈ô√≠prava aktu√°ln√≠ho data a ƒçasu ve form√°tu DD.MM.YYYY HH:MM
                const now = new Date();
                const formattedDate = `${now.getDate()}.${now.getMonth() + 1}.${now.getFullYear()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                // Parametry pro EmailJS
                const templateParams = {
                    email: user.email,                    // E-mail p≈ô√≠jemce
                    name: user.name,                      // Jm√©no p≈ô√≠jemce
                    customer_name: user.name,             // Jm√©no z√°kazn√≠ka
                    user_email: user.email,               // E-mail z√°kazn√≠ka
                    coffee_name: "Dobit√≠ kreditu",        // N√°zev operace
                    price: amount,                        // ƒå√°stka dobit√≠
                    old_credit: oldBalance,               // Kredit p≈ôed dob√≠jen√≠m
                    new_credit: newBalance,               // Kredit po dob√≠jen√≠
                    date: formattedDate,                  // Aktu√°ln√≠ datum a ƒças
                    reply_to: coffeeshopEmail,            // E-mail pro odpovƒõƒè - cofeeshopsfs@gmail.com
                    cc_email: adminEmail,                 // Kopie e-mailu pro admina
                    from_name: "WEBCofee Automat",        // Nov√Ω parametr - jm√©no odes√≠latele (m√≠sto Jan Bla≈æek)
                    from_email: coffeeshopEmail           // Nov√Ω parametr - e-mail odes√≠latele
                };
                
                // Odesl√°n√≠ e-mailu s univerz√°ln√≠ ≈°ablonou (pou≈æ√≠v√°me stejnou jako pro objedn√°vku k√°vy)
                // P≈ôid√°me parametr pro p≈ôedmƒõt e-mailu, aby bylo jasn√©, ≈æe jde o dobit√≠ kreditu
                templateParams.subject = 'Nav√Ω≈°en√≠ kreditu';
                templateParams.email_type = 'credit'; // Pro identifikaci typu e-mailu v ≈°ablonƒõ
                
                const response = await emailjs.send(
                    'service_p80izio',                    // Service ID
                    'template_fdm14kg',                   // Template ID - univerz√°ln√≠ ≈°ablona
                    templateParams
                );
                
                console.log('E-mail o dobit√≠ √∫spƒõ≈°nƒõ odesl√°n:', response);
                return true;
            } catch (error) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠ e-mailu o dobit√≠:', error);
                showToast('‚ö†Ô∏è', 'Upozornƒõn√≠', 'E-mailovou notifikaci o dobit√≠ se nepoda≈ôilo odeslat, ale kredit byl dob√≠t', 'warning');
                return false;
            }
        }
        
        // Potvrzen√≠ objedn√°vky
        async function handleConfirmOrder() {
            // Obnoven√≠ dat objedn√°vky z localStorage pro p≈ô√≠pad, ≈æe currentOrder byl ztracen
            if (!currentOrder || !currentOrder.product) {
                const savedProduct = localStorage.getItem('tempOrderProduct');
                const savedPrice = localStorage.getItem('tempOrderPrice');
                
                if (savedProduct && savedPrice) {
                    currentOrder = {
                        product: savedProduct,
                        price: parseInt(savedPrice)
                    };
                    console.log('Objedn√°vka obnovena z localStorage:', currentOrder);
                }
            }
            
            if (!currentUser || !currentOrder) {
                console.error('Nelze prov√©st objedn√°vku: chyb√≠ u≈æivatel nebo data objedn√°vky');
                hideOrderModal();
                return;
            }
            
            // Pro jistotu zkontrolujeme, zda m√°me v≈°echny pot≈ôebn√© √∫daje
            if (!currentOrder.product) {
                console.error('Chyb√≠ √∫daj o produktu v objedn√°vce');
                showToast('‚ùå', 'Chyba', 'Neplatn√° objedn√°vka, zkuste to znovu', 'error');
                hideOrderModal();
                return;
            }
            
            try {
                // OPRAVENO: Pro objedn√°vku pou≈æ√≠v√°me KLADNOU ƒç√°stku (d≈Øle≈æit√©!)
                // Datab√°zov√Ω trigger oƒçek√°v√° kladnou hodnotu pro objedn√°vky (type = 'order')
                // a s√°m prov√°d√≠ odeƒçet pomoc√≠: balance = balance - amount
                const price = Math.abs(currentOrder.price); // Zajist√≠me, ≈æe ƒç√°stka bude v≈ædy kladn√°
                const oldBalance = currentUser.balance; // Zapamatujeme si p≈Øvodn√≠ z≈Østatek
                
                // OPRAVENO: Definice productName P≈òED jeho pou≈æit√≠m v console.log
                const orderProduct = currentOrder.product; // Ulo≈æ√≠me si produkt pro pozdƒõj≈°√≠ pou≈æit√≠
                
                console.log('Zpracov√°n√≠ objedn√°vky:', {
                    product: orderProduct,
                    price: price,
                    oldBalance: oldBalance,
                    userId: currentUser.id
                });
                
                // Vytvo≈ôen√≠ transakce
                const { error: transactionError } = await supabaseClient
                    .from('transactions')
                    .insert({
                        user_id: currentUser.id,
                        type: 'order',
                        amount: price, // Kladn√° hodnota pro odeƒçet z kreditu (trigger to odeƒçte)
                        description: `Objedn√°vka: ${orderProduct}`
                    });
                
                if (transactionError) throw transactionError;
                
                // Naƒçten√≠ aktu√°ln√≠ho z≈Østatku a e-mailu z datab√°ze po proveden√≠ transakce
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('balance, email, name')
                    .eq('id', currentUser.id)
                    .single();
                
                if (userError) throw userError;
                
                console.log('P≈Øvodn√≠ z≈Østatek:', oldBalance, 'Nov√Ω z≈Østatek:', userData.balance);
                
                // Aktualizace UI
                currentUser.balance = userData.balance; // Pou≈æijeme z≈Østatek p≈ô√≠mo z datab√°ze
                currentUser.email = userData.email;     // Aktualizace e-mailu v currentUser
                
                const balanceElement = document.getElementById('userDashboardBalance');
                balanceElement.textContent = `${userData.balance} Kƒç`;
                balanceElement.className = userData.balance >= 0 ? 'text-3xl font-bold balance-positive' : 'text-3xl font-bold balance-negative';
                
                // Odesl√°n√≠ e-mailu o objedn√°vce
                try {
                    console.log('Odes√≠l√°n√≠ e-mailu s parametry:', {
                        user: userData.name,
                        email: userData.email,
                        product: orderProduct,
                        price: price,
                        oldBalance: oldBalance,
                        newBalance: userData.balance
                    });
                    
                    const emailSent = await sendOrderEmail(
                        userData,                  // Aktualizovan√° data u≈æivatele
                        orderProduct,              // N√°zev produktu (s kontrolou null)
                        price,                     // Cena (nyn√≠ kladn√° hodnota)
                        oldBalance,                // P≈Øvodn√≠ z≈Østatek
                        userData.balance           // Nov√Ω z≈Østatek
                    );
                    
                    if (emailSent) {
                        console.log('E-mailov√° notifikace odesl√°na');
                    } else {
                        console.warn('E-mailovou notifikaci se nepoda≈ôilo odeslat');
                    }
                } catch (emailError) {
                    console.error('Chyba p≈ôi odes√≠l√°n√≠ e-mailu:', emailError);
                    // Nezastavujeme proces objedn√°vky kv≈Øli chybƒõ e-mailu
                }
                
                // Naƒçten√≠ transakc√≠ u≈æivatele
                loadUserTransactions(currentUser.id);
                
                // ƒåi≈°tƒõn√≠ localStorage po dokonƒçen√≠ objedn√°vky
                localStorage.removeItem('tempOrderProduct');
                localStorage.removeItem('tempOrderPrice');
                
                hideOrderModal();
                showToast('‚úÖ', '√öspƒõch', `Objedn√°vka ${orderProduct} byla √∫spƒõ≈°nƒõ provedena`, 'success');
            } catch (error) {
                console.error('Chyba p≈ôi zpracov√°n√≠ objedn√°vky:', error);
                showToast('‚ùå', 'Chyba', 'Nepoda≈ôilo se zpracovat objedn√°vku', 'error');
                hideOrderModal();
            }
        }
        
        // ===== Transakce =====
        
        // Naƒçten√≠ transakc√≠ u≈æivatele
        async function loadUserTransactions(userId) {
            try {
                const { data, error } = await supabaseClient
                    .from('transactions')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                const transListEl = document.getElementById('userTransactionsList');
                transListEl.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(trans => {
                        const date = new Date(trans.created_at);
                        const formattedDate = `${date.getDate()}.${date.getMonth()+1}.${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                        
                        // Robustnƒõj≈°√≠ logika rozpozn√°n√≠ typu transakce (sjednocen√≠ s admin histori√≠)
                        let color, amount, icon, typeText;
                        
                        if (trans.type === 'credit') {
                            // Dobit√≠ kreditu
                            color = 'transaction-credit';
                            amount = `+${trans.amount}`;
                            icon = 'üí∞';
                            typeText = 'Dobit√≠';
                        } else if (trans.type === 'descaling') {
                            // Odv√°pnƒõn√≠
                            color = 'transaction-descaling';
                            amount = `0`;
                            icon = 'üßπ';
                            typeText = 'Odv√°pnƒõn√≠';
                        } else {
                            // Objedn√°vka k√°vy (type='order')
                            color = 'transaction-debit';
                            amount = `-${Math.abs(trans.amount)}`;
                            icon = '‚òï';
                            typeText = 'Objedn√°vka';
                        }
                        
                        transListEl.innerHTML += `
                            <tr>
                                <td class="font-medium p-2 sm:p-3">${formattedDate}</td>
                                <td class="font-medium p-2 sm:p-3">${icon} ${typeText}</td>
                                <td class="${color} p-2 sm:p-3 text-right">${amount} Kƒç</td>
                                <td class="font-medium p-2 sm:p-3 hidden sm:table-cell">${trans.description}</td>
                            </tr>
                        `;
                    });
                } else {
                    transListEl.innerHTML = '<tr><td colspan="4" class="text-center p-3 font-medium">‚ùå ≈Ω√°dn√© transakce</td></tr>';
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ transakc√≠:', error);
                document.getElementById('userTransactionsList').innerHTML = '<tr><td colspan="4" class="text-center p-3 font-medium" style="color: var(--red);">‚ùå Nepoda≈ôilo se naƒç√≠st transakce</td></tr>';
            }
        }
        
        // Naƒçten√≠ v≈°ech transakc√≠ pro admin panel
        async function loadAllTransactions() {
            try {
                const { data, error } = await supabaseClient
                    .from('transactions')
                    .select('*, users(name)')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                const transListEl = document.getElementById('allTransactionsList');
                transListEl.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(trans => {
                        const date = new Date(trans.created_at);
                        const formattedDate = `${date.getDate()}.${date.getMonth()+1}.${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                        
                        // Nastaven√≠ barvy, ikony a textu podle typu transakce
                        let color, amount, icon, typeText, userName;
                        
                        if (trans.type === 'cash_register') {
                            // Transakce pokladny
                            if (trans.description.includes('Nav√Ω≈°en√≠')) {
                                color = 'transaction-credit';
                                amount = `+${trans.amount} Kƒç`;
                                icon = 'üíµ';
                            } else {
                                color = 'transaction-debit';
                                amount = `-${trans.amount} Kƒç`;
                                icon = 'üíµ';
                            }
                            typeText = 'Pokladna';
                            userName = 'üí∞ Pokladna';
                        } else if (trans.type === 'credit') {
                            // Dobit√≠ kreditu
                            color = 'transaction-credit';
                            amount = `+${trans.amount} Kƒç`;
                            icon = 'üí∞';
                            typeText = 'Dobit√≠';
                            userName = `üë§ ${trans.users?.name || 'Nezn√°m√Ω u≈æivatel'}`;
                        } else if (trans.type === 'descaling') {
                            // Odv√°pnƒõn√≠
                            color = 'transaction-descaling';
                            amount = `0 Kƒç`;
                            icon = 'üßπ';
                            typeText = 'Odv√°pnƒõn√≠';
                            userName = `üë§ ${trans.users?.name || 'Nezn√°m√Ω u≈æivatel'}`;
                        } else {
                            // Objedn√°vka k√°vy
                            color = 'transaction-debit';
                            amount = `-${Math.abs(trans.amount)} Kƒç`;
                            icon = '‚òï';
                            typeText = 'Objedn√°vka';
                            userName = `üë§ ${trans.users?.name || 'Nezn√°m√Ω u≈æivatel'}`;
                        }
                        
                        transListEl.innerHTML += `
                            <tr>
                                <td class="font-medium p-2">${formattedDate}</td>
                                <td class="font-medium p-2 hidden sm:table-cell">${userName}</td>
                                <td class="font-medium p-2">${icon} ${typeText}</td>
                                <td class="${color} p-2 text-right">${amount}</td>
                                <td class="font-medium p-2 hidden lg:table-cell">${trans.description}</td>
                            </tr>
                        `;
                    });
                } else {
                    transListEl.innerHTML = '<tr><td colspan="5" class="text-center p-3 font-medium">‚ùå ≈Ω√°dn√© transakce</td></tr>';
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ transakc√≠:', error);
                document.getElementById('allTransactionsList').innerHTML = '<tr><td colspan="5" class="text-center p-3 font-medium" style="color: var(--red);">‚ùå Nepoda≈ôilo se naƒç√≠st transakce</td></tr>';
            }
        }
        
        // ===== Pomocn√© funkce =====
        
        // Zobrazen√≠ toast notifikace
        function showToast(icon, title, message, type) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            // Set icon and content
            toastIcon.textContent = icon;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Set color based on type
            if (type === 'error') {
                toastIcon.style.color = 'var(--red)';
                toastTitle.style.color = 'var(--red)';
            } else if (type === 'success') {
                toastIcon.style.color = 'var(--black)';
                toastTitle.style.color = 'var(--black)';
            } else if (type === 'warning') {
                toastIcon.style.color = 'var(--gray)';
                toastTitle.style.color = 'var(--gray)';
            }
            
            // Show toast
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('opacity-100');
            }, 10);
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        // NFC Authentication Functions
        let nfcReader = null;
        
        async function initNFC() {
            try {
                console.log('üîÑ Inicializace NFC...');
                
                if (!('NDEFReader' in window)) {
                    throw new Error('NDEFReader nen√≠ podporov√°n v tomto prohl√≠≈æeƒçi');
                }
                
                console.log('‚úÖ NDEFReader je dostupn√Ω');
                nfcReader = new NDEFReader();
                console.log('‚úÖ NFC Reader vytvo≈ôen √∫spƒõ≈°nƒõ');
                
                return true;
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi inicializaci NFC:', error);
                return false;
            }
        }
        
        async function startNFCLogin() {
            console.log('üîç NFC Login: Zaƒç√°tek diagnostiky');
            
            // Detailn√≠ kontrola prost≈ôed√≠
            console.log('üîç User Agent:', navigator.userAgent);
            console.log('üîç Protocol:', window.location.protocol);
            console.log('üîç NDEFReader dostupn√Ω:', 'NDEFReader' in window);
            
            try {
                // Kontrola HTTPS
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    throw new Error('NFC vy≈æaduje HTTPS p≈ôipojen√≠');
                }
                
                // Kontrola NFC API
                if (!('NDEFReader' in window)) {
                    throw new Error('NDEFReader nen√≠ podporov√°n v tomto prohl√≠≈æeƒçi. Pot≈ôebujete Chrome na Android.');
                }
                
                console.log('‚úÖ NFC API je dostupn√©');
                
                if (!nfcReader) {
                    console.log('üîÑ Inicializace NFC readeru...');
                    const nfcInitialized = await initNFC();
                    if (!nfcInitialized) {
                        throw new Error('Nepoda≈ôilo se inicializovat NFC reader');
                    }
                }
                
                console.log('‚úÖ NFC reader inicializov√°n');
                showToast('üì±', 'NFC', 'P≈ôilo≈æte NFC kartu k za≈ô√≠zen√≠...', 'info');
                
                console.log('üîÑ Spou≈°t√≠m NFC scan...');
                await nfcReader.scan();
                console.log('‚úÖ NFC scan spu≈°tƒõn √∫spƒõ≈°nƒõ');
                
                nfcReader.addEventListener('reading', async ({ message, serialNumber }) => {
                    console.log('üéâ NFC karta detekov√°na!');
                    console.log('üì± Serial Number:', serialNumber);
                    console.log('üìã Message:', message);
                    
                    // Pou≈æijeme serialNumber jako identifik√°tor karty
                    const nfcCardId = serialNumber;
                    
                    if (!nfcCardId || nfcCardId.length < 4) {
                        console.error('‚ùå Neplatn√© NFC ID:', nfcCardId);
                        showToast('‚ùå', 'NFC Error', 'Neplatn√© NFC ID karty', 'error');
                        return;
                    }
                    
                    // Pokus√≠me se p≈ôihl√°sit u≈æivatele
                    console.log('üîÑ P≈ôihla≈°ov√°n√≠ s NFC ID:', nfcCardId);
                    await handleCardLogin(nfcCardId, 'NFC');
                    
                    // Zastav√≠me ƒçten√≠ NFC
                    console.log('üõë Zastavov√°n√≠ NFC scan...');
                    await nfcReader.stop();
                });
                
                nfcReader.addEventListener('readingerror', (error) => {
                    console.error('‚ùå Chyba p≈ôi ƒçten√≠ NFC karty:', error);
                    showToast('‚ùå', 'NFC Error', 'Chyba p≈ôi ƒçten√≠ NFC karty', 'error');
                });
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi spu≈°tƒõn√≠ NFC p≈ôihl√°≈°en√≠:', error);
                console.error('‚ùå Error name:', error.name);
                console.error('‚ùå Error message:', error.message);
                
                let errorMessage = 'Nezn√°m√° chyba NFC';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'NFC p≈ô√≠stup byl odm√≠tnut. Povolte NFC v nastaven√≠ prohl√≠≈æeƒçe a zkuste znovu.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'NFC nen√≠ podporov√°no na tomto za≈ô√≠zen√≠ nebo v tomto prohl√≠≈æeƒçi.';
                } else if (error.message.includes('HTTPS')) {
                    errorMessage = 'NFC vy≈æaduje zabezpeƒçen√© HTTPS p≈ôipojen√≠.';
                } else if (error.message.includes('NDEFReader')) {
                    errorMessage = 'NFC nen√≠ podporov√°no. Pot≈ôebujete Chrome na Android za≈ô√≠zen√≠.';
                } else {
                    errorMessage = `NFC chyba: ${error.message}`;
                }
                
                showToast('‚ùå', 'NFC Error', errorMessage, 'error');
                
                // Zobrazen√≠ diagnostick√Ωch informac√≠
                console.log('üîç DIAGNOSTIKA NFC:');
                console.log('- Prohl√≠≈æeƒç:', navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Jin√Ω prohl√≠≈æeƒç');
                console.log('- Android:', navigator.userAgent.includes('Android') ? 'Ano' : 'Ne');
                console.log('- HTTPS:', window.location.protocol === 'https:' ? 'Ano' : 'Ne');
                console.log('- NDEFReader:', 'NDEFReader' in window ? 'Dostupn√Ω' : 'Nedostupn√Ω');
            }
        }
        
        // Biometric Authentication Functions
        async function startBiometricLogin() {
            console.log('üîç BIOMETRIC LOGIN DEBUG: Zaƒç√°tek');
            
            try {
                // Detailn√≠ debugging informace
                console.log('üîç window.PublicKeyCredential:', !!window.PublicKeyCredential);
                console.log('üîç navigator.credentials:', !!navigator.credentials);
                console.log('üîç window.location.hostname:', window.location.hostname);
                console.log('üîç window.location.origin:', window.location.origin);
                
                // Nejprve zkontrolujeme, zda v≈Øbec m√°me nƒõjak√© biometrick√© kl√≠ƒçe ulo≈æen√©
                console.log('üîç Kontroluji dostupn√© biometrick√© kl√≠ƒçe...');
                
                try {
                    // Zkus√≠me z√≠skat informace o dostupn√Ωch kl√≠ƒç√≠ch pomoc√≠ newer API
                    if ('PublicKeyCredential' in window && 
                        'isUserVerifyingPlatformAuthenticatorAvailable' in window.PublicKeyCredential) {
                        
                        const isPlatformSupported = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                        console.log('üîç Platform authenticator available:', isPlatformSupported);
                        
                        if (!isPlatformSupported) {
                            throw new Error('Biometrick√° autentifikace nen√≠ dostupn√° na tomto za≈ô√≠zen√≠');
                        }
                    }
                } catch (supportError) {
                    console.warn('‚ö†Ô∏è Nelze detekovat podporu biometrick√Ωch kl√≠ƒç≈Ø:', supportError);
                }
                
                if (!window.PublicKeyCredential) {
                    throw new Error('WebAuthn nen√≠ podporov√°no v tomto prohl√≠≈æeƒçi');
                }
                
                // Kontrola dostupnosti biometrick√Ωch autentifik√°tor≈Ø
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                console.log('üîç Biometric available:', available);
                
                if (!available) {
                    throw new Error('Biometrick√© ovƒõ≈ôen√≠ nen√≠ k dispozici na tomto za≈ô√≠zen√≠');
                }
                
                // Zkus√≠me zjistit, jak√© credentials m√°me v datab√°zi
                console.log('üîç Naƒç√≠t√°m registered credentials z datab√°ze...');
                const { data: registeredUsers, error: dbError } = await supabaseClient
                    .from('users')
                    .select('biometric_id, name')
                    .not('biometric_id', 'is', null);
                
                if (dbError) {
                    console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ credentials z DB:', dbError);
                } else {
                    console.log('üîç Registered credentials:', registeredUsers);
                }
                
                showToast('üëÜ', 'Biometrick√©', 'Pou≈æijte biometrick√© ovƒõ≈ôen√≠...', 'info');
                
                // Vytvo≈ôen√≠ challenge pro autentifikaci
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);
                console.log('üîç Generated challenge:', Array.from(challenge));
                
                // Z√≠sk√°me dom√©nu pro spr√°vn√© RP ID
                const hostname = window.location.hostname;
                console.log('üîç Netlify domain check:', hostname.includes('netlify.app'));
                
                // Urƒçen√≠ RP ID podle dom√©ny - OPRAVENO pro Netlify
                let effectiveRpId;
                if (hostname === 'localhost') {
                    effectiveRpId = hostname;
                } else if (hostname.includes('netlify.app')) {
                    // Pro Netlify pou≈æ√≠v√°me plnou dom√©nu m√≠sto 'netlify.app'
                    // WebAuthn vy≈æaduje, aby rpId bylo stejn√© nebo nad≈ôazen√© aktu√°ln√≠ dom√©nƒõ
                    effectiveRpId = hostname; // sfs-webcofee.netlify.app
                } else {
                    effectiveRpId = hostname;
                }
                
                console.log('üîç Effective RP ID for authentication:', effectiveRpId);
                
                // NOV√ù P≈ò√çSTUP: Naƒçteme konkr√©tn√≠ biometrick√© kl√≠ƒçe z datab√°ze
                console.log('üîç Naƒç√≠t√°m registrovan√© biometrick√© kl√≠ƒçe z datab√°ze...');
                
                const { data: usersWithBiometric, error: biometricError } = await supabaseClient
                    .from('users')
                    .select('id, name, biometric_id')
                    .not('biometric_id', 'is', null);

                if (biometricError) {
                    console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ biometrick√Ωch kl√≠ƒç≈Ø:', biometricError);
                    throw new Error('Nelze naƒç√≠st registrovan√© biometrick√© kl√≠ƒçe');
                }

                console.log('üîç Nalezen√© biometrick√© kl√≠ƒçe:', usersWithBiometric);
                
                if (!usersWithBiometric || usersWithBiometric.length === 0) {
                    throw new Error('Nejsou registrov√°ny ≈æ√°dn√© biometrick√© kl√≠ƒçe. Zaregistrujte se nejprve v admin sekci.');
                }
                
                // Detailn√≠ log biometrick√Ωch kl√≠ƒç≈Ø pro diagnostiku
                usersWithBiometric.forEach(user => {
                    console.log(`üîç U≈æivatel: ${user.name}, biometric_id form√°t: ${user.biometric_id ? user.biometric_id.substring(0, 10) + '...' : 'null'}`);
                });

                if (!usersWithBiometric || usersWithBiometric.length === 0) {
                    throw new Error('Nejsou registrov√°ny ≈æ√°dn√© biometrick√© kl√≠ƒçe. Zaregistrujte se nejprve v admin sekci.');
                }

                // Vytvo≈ô√≠me allowCredentials ze v≈°ech dostupn√Ωch kl√≠ƒç≈Ø
                const allowCredentials = usersWithBiometric
                    .filter(user => !!user.biometric_id) // Ignorujeme p≈ô√≠padn√© null hodnoty
                    .map(user => {
                        console.log('üîç Zpracov√°v√°m biometric_id:', user.biometric_id, 'pro u≈æivatele:', user.name);
                        
                        // Bezpeƒçn√© dek√≥dov√°n√≠ base64 - obaleno v try-catch
                        let rawId;
                        try {
                            // Normalizace base64 ≈ôetƒõzce (odstranƒõn√≠ neplatn√Ωch znak≈Ø)
                            let normalizedId = user.biometric_id;
                            
                            // Nejprve zkontrolujeme form√°t a o≈°et≈ô√≠me p≈ô√≠padn√© abnormality
                            if (normalizedId.includes('-') || normalizedId.includes('_')) {
                                // WebAuthn ƒçasto pou≈æ√≠v√° base64url form√°t, kter√Ω pou≈æ√≠v√° '-' a '_' m√≠sto '+' a '/'
                                normalizedId = normalizedId.replace(/-/g, '+').replace(/_/g, '/');
                                
                                // P≈ô√≠padnƒõ dopln√≠me chybƒõj√≠c√≠ '=' na konci
                                while (normalizedId.length % 4 !== 0) {
                                    normalizedId += '=';
                                }
                                console.log('üîç Normalizovan√Ω base64 ≈ôetƒõzec:', normalizedId);
                            }
                            
                            // Nyn√≠ se pokus√≠me dek√≥dovat
                            rawId = Uint8Array.from(atob(normalizedId), c => c.charCodeAt(0));
                            console.log('‚úÖ √öspƒõ≈°nƒõ dek√≥dov√°n biometric_id pro:', user.name);
                        } catch (decodeError) {
                            console.error('‚ùå Chyba p≈ôi dek√≥dov√°n√≠ biometric_id:', decodeError);
                            console.log('‚ùå Pro u≈æivatele:', user.name);
                            
                            // Pokud se nepoda≈ô√≠ dek√≥dovat, vr√°t√≠me null a pozdƒõji tyto z√°znamy odfiltrujeme
                            return null;
                        }
                        
                        // Vr√°t√≠me credential objekt
                        return {
                            type: 'public-key',
                            id: rawId,
                            transports: ['internal', 'hybrid', 'usb'] // roz≈°√≠≈ôen√° podpora pro r≈Øzn√© transporty
                        };
                    })
                    .filter(cred => cred !== null); // Odstran√≠me v≈°echny neplatn√© credential

                console.log('üîç Prepared allowCredentials:', allowCredentials);

                // Nov√Ω pokus s konkr√©tn√≠mi allowCredentials
                const publicKeyCredentialRequestOptions = {
                    challenge: challenge,
                    allowCredentials: allowCredentials, // Pou≈æ√≠v√°me konkr√©tn√≠ kl√≠ƒçe z datab√°ze
                    userVerification: 'preferred', // Zmƒõna z 'discouraged' na 'preferred' pro lep≈°√≠ kompatibilitu
                    timeout: 300000, // Del≈°√≠ timeout (5 minut) pro v√≠c ƒçasu na ovƒõ≈ôen√≠
                    rpId: effectiveRpId
                };
                
                console.log('üîç Authentication options:', publicKeyCredentialRequestOptions);
                console.log('üîç Spou≈°t√≠m navigator.credentials.get()...');
                
                const credential = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions,
                    mediation: 'optional' // Povolit mediaci pro lep≈°√≠ UX
                });
                
                if (credential) {
                    // Uspƒõ≈°n√© biometrick√© ovƒõ≈ôen√≠
                    console.log('‚úÖ Biometrick√© ovƒõ≈ôen√≠ √∫spƒõ≈°n√©!');
                    console.log('üîç credential.id:', credential.id);
                    console.log('üîç credential.rawId:', credential.rawId);
                    console.log('üîç credential.type:', credential.type);
                    
                    // P≈ôevedeme credential.id na base64url string pro porovn√°n√≠ s datab√°z√≠
                    const credentialIdBase64 = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=/g, '');
                    
                    console.log('üîç Credential ID (base64url):', credentialIdBase64);
                    console.log('üîç Credential ID (original):', credential.id);
                    
                        // P≈ôevedeme credential ID na r≈Øzn√© form√°ty pro porovn√°n√≠
                    const credentialIdRaw = credential.id;
                    
                    console.log('üîç Hled√°m u≈æivatele podle credential ID:');
                    console.log('- Raw credential.id:', credentialIdRaw);
                    console.log('- Base64 encoded:', credentialIdBase64);
                    
                    // Flexibilnƒõj≈°√≠ hled√°n√≠ u≈æivatele s ohledem na r≈Øzn√© form√°ty base64
                    let foundUser = null;
                    
                    // Pokus√≠me se naj√≠t u≈æivatele pomoc√≠ r≈Øzn√Ωch transformac√≠ ID
                    for (const user of usersWithBiometric) {
                        console.log(`üîç Porovn√°v√°m s u≈æivatelem: ${user.name}`);
                        
                        if (!user.biometric_id) continue;
                        
                        // P≈ô√≠m√© porovn√°n√≠
                        if (user.biometric_id === credentialIdBase64 || 
                            user.biometric_id === credentialIdRaw) {
                            console.log('‚úÖ Nalezen u≈æivatel p≈ô√≠m√Ωm porovn√°n√≠m:', user.name);
                            foundUser = user;
                            break;
                        }
                        
                        // Porovn√°n√≠ s normalizac√≠
                        const normalizedStored = user.biometric_id
                            .replace(/=+$/, '')  // Odstran√≠me padding na konci
                            .replace(/\+/g, '-').replace(/\//g, '_'); // base64url konvence
                            
                        const normalizedReceived = credentialIdBase64
                            .replace(/=+$/, '')
                            .replace(/\+/g, '-').replace(/\//g, '_');
                            
                        if (normalizedStored === normalizedReceived) {
                            console.log('‚úÖ Nalezen u≈æivatel po normalizaci:', user.name);
                            foundUser = user;
                            break;
                        }
                    }
                    
                    if (foundUser) {
                        console.log('‚úÖ U≈æivatel nalezen:', foundUser.name);
                        await handleBiometricLogin(foundUser.id);
                    } else {
                        console.error('‚ùå U≈æivatel s t√≠mto biometrick√Ωm kl√≠ƒçem nebyl nalezen');
                        throw new Error('U≈æivatel s t√≠mto biometrick√Ωm kl√≠ƒçem nebyl nalezen');
                    }
                } else {
                    throw new Error('Biometrick√© ovƒõ≈ôen√≠ selhalo - ≈æ√°dn√© credential vr√°ceno');
                }
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi biometrick√©m p≈ôihl√°≈°en√≠:', error);
                console.error('‚ùå Error name:', error.name);
                console.error('‚ùå Error message:', error.message);
                console.error('‚ùå Error stack:', error.stack);
                
                // Podrobnƒõj≈°√≠ zpracov√°n√≠ zn√°m√Ωch chyb WebAuthn
                if (error.name === 'NotAllowedError') {
                    console.log('üîç NotAllowedError - bƒõ≈æn√° chyba p≈ôi prvn√≠m pou≈æit√≠ nebo kdy≈æ nen√≠ zaregistrov√°n ≈æ√°dn√Ω kl√≠ƒç');
                    
                    showToast('‚ùå', 'Biometric Error', 'Biometrick√© ovƒõ≈ôen√≠ bylo zru≈°eno nebo nen√≠ dostupn√©. Pot≈ôebujete se nejprve zaregistrovat v admin sekci.', 'error');
                    
                    // Zobrazit dal≈°√≠ n√°povƒõdu v konzoli
                    console.log('üí° ≈òE≈†EN√ç: P≈ôihlaste se nejprve RFID kartou, pak v admin sekci zaregistrujte biometrick√© ovƒõ≈ôen√≠ pro va≈°eho u≈æivatele');
                    
                } else if (error.name === 'NotSupportedError') {
                    showToast('‚ùå', 'Biometric Error', 'Biometrick√© ovƒõ≈ôen√≠ nen√≠ podporov√°no na va≈°em za≈ô√≠zen√≠ nebo prohl√≠≈æeƒçi. Zkuste Edge nebo Chrome.', 'error');
                } else if (error.name === 'InvalidStateError') {
                    showToast('‚ùå', 'Biometric Error', 'Nejsou k dispozici ≈æ√°dn√© p≈ô√≠stupov√© kl√≠ƒçe na tomto za≈ô√≠zen√≠. Zkuste se nejprve zaregistrovat v admin sekci.', 'error');
                } else if (error.name === 'SecurityError') {
                    showToast('‚ùå', 'Biometric Error', 'Bezpeƒçnostn√≠ chyba WebAuthn. Zkontrolujte adresu str√°nky a zkuste to znovu.', 'error');
                } else if (error.message.includes('privacy-considerations-client')) {
                    showToast('‚ùå', 'Biometric Error', 'V√°≈° prohl√≠≈æeƒç m√° omezen√≠ pro WebAuthn. Zkuste Chrome nebo Edge se zapnut√Ωm Windows Hello.', 'error');
                } else {
                    showToast('‚ùå', 'Biometric Error', 'Chyba p≈ôi biometrick√©m ovƒõ≈ôen√≠: ' + error.message, 'error');
                }
            }
        }
        
        // Registrace biometrick√© autentifikace pro u≈æivatele
        async function registerBiometric(userId, userName) {
            try {
                console.log('üîç BIOMETRIC REGISTER DEBUG: Zaƒç√°tek registrace pro ID:', userId);
                
                if (!window.PublicKeyCredential) {
                    throw new Error('WebAuthn nen√≠ podporov√°no v tomto prohl√≠≈æeƒçi');
                }
                
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                console.log('üîç Biometric available:', available);
                
                if (!available) {
                    throw new Error('Biometrick√© ovƒõ≈ôen√≠ nen√≠ k dispozici na tomto za≈ô√≠zen√≠');
                }
                
                showToast('üëÜ', 'Biometrick√©', 'Registrace biometrick√©ho ovƒõ≈ôen√≠...', 'info');
                
                // Vytvo≈ôen√≠ challenge pro registraci
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);
                console.log('üîç Challenge created:', Array.from(challenge));
                
                // Vytvo≈ôen√≠ user ID z userId
                const userIdBuffer = new TextEncoder().encode(userId);
                console.log('üîç User ID buffer:', Array.from(userIdBuffer));
                
                // Z√≠sk√°me dom√©nu pro spr√°vn√© RP ID
                const hostname = window.location.hostname;
                
                // Urƒçen√≠ RP ID podle dom√©ny - OPRAVENO pro Netlify
                let effectiveRpId;
                if (hostname === 'localhost') {
                    effectiveRpId = hostname;
                } else if (hostname.includes('netlify.app')) {
                    // Pro Netlify pou≈æ√≠v√°me plnou dom√©nu m√≠sto 'netlify.app'
                    // WebAuthn vy≈æaduje, aby rpId bylo stejn√© nebo nad≈ôazen√© aktu√°ln√≠ dom√©nƒõ
                    effectiveRpId = hostname; // sfs-webcofee.netlify.app
                } else {
                    effectiveRpId = hostname;
                }
                
                console.log('üîç Effective RP ID for registration:', effectiveRpId);
                console.log('üîç Full hostname:', hostname);
                console.log('üîç Location origin:', window.location.origin);
                
                const publicKeyCredentialCreationOptions = {
                    challenge: challenge,
                    rp: {
                        name: "WEBCofee",
                        id: effectiveRpId // Pou≈æ√≠v√°me spr√°vn√© RP ID podle dom√©ny
                    },
                    user: {
                        id: userIdBuffer,
                        name: userName,
                        displayName: userName,
                    },
                    pubKeyCredParams: [
                        { alg: -7, type: "public-key" }, // ES256
                        { alg: -257, type: "public-key" } // RS256
                    ],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform",
                        userVerification: "preferred", // Zmƒõna na 'preferred' pro lep≈°√≠ kompatibilitu
                        requireResidentKey: false // Pro lep≈°√≠ kompatibilitu
                    },
                    timeout: 300000, // Del≈°√≠ timeout (5 minut) pro v√≠c ƒçasu na ovƒõ≈ôen√≠
                    attestation: "none" // Zmƒõna z "direct" na "none" pro lep≈°√≠ kompatibilitu
                };
                
                console.log('üîç Registration options:', publicKeyCredentialCreationOptions);
                console.log('üîç Spou≈°t√≠m navigator.credentials.create()...');
                
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });
                
                if (credential) {
                    console.log('‚úÖ Biometrick√° registrace √∫spƒõ≈°n√°!');
                    console.log('üîç Credential ID:', credential.id);
                    console.log('üîç Raw credential:', credential);
                    
                    // P≈ôevedeme credential.id na base64url string pro konzistentn√≠ ukl√°d√°n√≠
                    const credentialIdBase64 = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=/g, '');
                    
                    console.log('üîç Credential ID (base64url):', credentialIdBase64);
                    
                    // Ulo≈æ√≠me credential ID do datab√°ze pro dan√©ho u≈æivatele
                    const { error } = await supabaseClient
                        .from('users')
                        .update({ biometric_id: credentialIdBase64 })
                        .eq('id', userId);
                    
                    if (error) {
                        console.error('‚ùå DB update error:', error);
                        throw error;
                    }
                    
                    showToast('‚úÖ', '√öspƒõch', 'Biometrick√© ovƒõ≈ôen√≠ bylo √∫spƒõ≈°nƒõ zaregistrov√°no! Nyn√≠ se m≈Ø≈æete p≈ôihl√°sit pomoc√≠ otisku prstu.', 'success');
                    return credentialIdBase64;
                } else {
                    throw new Error('Registrace biometrick√©ho ovƒõ≈ôen√≠ selhala');
                }
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi registraci biometrick√©ho ovƒõ≈ôen√≠:', error);
                console.error('‚ùå Error name:', error.name);
                console.error('‚ùå Error message:', error.message);
                
                if (error.name === 'NotAllowedError') {
                    showToast('‚ùå', 'Biometric Error', 'Registrace byla zru≈°ena nebo odm√≠tnuta. Zkuste znovu a potvrƒète otisk prstu.', 'error');
                } else if (error.name === 'NotSupportedError') {
                    showToast('‚ùå', 'Biometric Error', 'Biometrick√© ovƒõ≈ôen√≠ nen√≠ podporov√°no. Zkuste jin√Ω prohl√≠≈æeƒç (Chrome/Edge).', 'error');
                } else {
                    showToast('‚ùå', 'Biometric Error', 'Chyba p≈ôi registraci: ' + error.message, 'error');
                }
                return null;
            }
        }
        
        // Zpracov√°n√≠ biometrick√©ho p≈ôihl√°≈°en√≠
        async function handleBiometricLogin(userId) {
            try {
                console.log('üîç handleBiometricLogin: Naƒç√≠t√°m u≈æivatele podle ID:', userId);
                
                // Hled√°me u≈æivatele podle ID m√≠sto biometric_id
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatele:', error);
                    showToast('‚ùå', 'Datab√°ze', 'Chyba p≈ôi naƒç√≠t√°n√≠ dat u≈æivatele', 'error');
                    return;
                }
                
                if (!data) {
                    console.error('‚ùå U≈æivatel s ID nebyl nalezen:', userId);
                    showToast('‚ö†Ô∏è', 'Neregistrov√°no', 'U≈æivatel nebyl nalezen. P≈ôihlaste se nejprve kartou.', 'warning');
                    return;
                }
                
                console.log('‚úÖ U≈æivatel √∫spƒõ≈°nƒõ naƒçten:', data.name);
                
                // √öspƒõ≈°n√© p≈ôihl√°≈°en√≠
                currentUser = data;
                showUserDashboard(currentUser);
                showToast('‚úÖ', 'P≈ôihl√°≈°eno', `V√≠tejte ${data.name}! (Biometrick√© ovƒõ≈ôen√≠)`, 'success');
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi biometrick√©m p≈ôihl√°≈°en√≠:', error);
                showToast('‚ùå', 'Chyba', 'Chyba p≈ôi biometrick√©m p≈ôihl√°≈°en√≠', 'error');
            }
        }
        
        // Roz≈°√≠≈ôen√° funkce pro zpracov√°n√≠ p≈ôihl√°≈°en√≠ kartou (RFID/NFC)
        async function handleCardLogin(cardId, cardType = 'RFID') {
            // Kontrola minim√°ln√≠ d√©lky karty (jen pro RFID)
            if (cardType === 'RFID' && cardId.length < 10) {
                console.log('RFID karta je p≈ô√≠li≈° kr√°tk√°:', cardId.length);
                showToast('‚ùå', 'Neplatn√° karta', 'Neplatn√° RFID karta - p≈ô√≠li≈° kr√°tk√°', 'error');
                
                // Vyƒçi≈°tƒõn√≠ input pole
                const rfidInput = document.getElementById('rfidInput');
                if (rfidInput) {
                    rfidInput.value = '';
                    rfidInput.focus();
                }
                return;
            }
            
            try {
                // Ovƒõ≈ôen√≠ RFID/NFC karty v datab√°zi - kontrola obou sloupc≈Ø
                let data = null;
                let error = null;
                
                // Nejd≈ô√≠ve zkus√≠me naj√≠t podle typu karty
                if (cardType === 'RFID') {
                    // Pro RFID hled√°me v rfid_card_id
                    const result = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('rfid_card_id', cardId)
                        .single();
                    data = result.data;
                    error = result.error;
                } else if (cardType === 'NFC') {
                    // Pro NFC hled√°me v nfc_card_id
                    const result = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('nfc_card_id', cardId)
                        .single();
                    data = result.data;
                    error = result.error;
                }
                
                // Pokud jsme u≈æivatele nena≈°li podle typu, zkus√≠me hledat v obou sloupc√≠ch
                if (!data && error && error.code === 'PGRST116') {
                    console.log(`U≈æivatel nenalezen v ${cardType === 'RFID' ? 'rfid_card_id' : 'nfc_card_id'}, zkou≈°√≠m oba sloupce...`);
                    
                    const result = await supabaseClient
                        .from('users')
                        .select('*')
                        .or(`rfid_card_id.eq.${cardId},nfc_card_id.eq.${cardId}`)
                        .single();
                    data = result.data;
                    error = result.error;
                }
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                if (data) {
                    // U≈æivatel nalezen - v≈°ichni u≈æivatel√© vƒçetnƒõ admin karty se p≈ôihl√°s√≠ do user dashboardu
                    currentUser = data;
                    showUserDashboard(currentUser);
                    showToast('‚úÖ', 'P≈ôihl√°≈°eno', `V√≠tejte ${data.name}! (${cardType})`, 'success');
                } else {
                    // U≈æivatel nenalezen - HOST p≈ô√≠stup
                    const hostUser = {
                        id: 'host',
                        name: 'HOST',
                        rfid_card_id: cardId,
                        balance: 0,
                        email: 'host@sfs.com'
                    };
                    
                    // P≈ôid√°me informaci o pou≈æit√© kartƒõ (pro zobrazen√≠ v UI)
                    hostUser.guest_card = cardId;
                    
                    // P≈ôihl√°s√≠me jako HOST
                    currentUser = hostUser;
                    showUserDashboard(currentUser);
                    showToast('üë§', 'HOST p≈ô√≠stup', `P≈ôihl√°≈°en jako HOST (${cardType}) - Karta: ${cardId}`, 'info');
                }
                
                // Vyƒçi≈°tƒõn√≠ input pole
                const rfidInput = document.getElementById('rfidInput');
                if (rfidInput) {
                    rfidInput.value = '';
                    rfidInput.focus();
                }
                
            } catch (error) {
                console.error('Chyba p≈ôi p≈ôihl√°≈°en√≠ kartou:', error);
                showToast('‚ùå', 'Chyba', 'Chyba p≈ôi p≈ôihl√°≈°en√≠', 'error');
            }
        }
        
        // Funkce pro odebr√°n√≠ biometrick√©ho ovƒõ≈ôen√≠
        async function removeBiometric(userId) {
            try {
                if (!confirm('Opravdu chcete odebrat biometrick√© ovƒõ≈ôen√≠ pro tohoto u≈æivatele?')) {
                    return;
                }
                
                const { error } = await supabaseClient
                    .from('users')
                    .update({ biometric_id: null })
                    .eq('id', userId);
                
                if (error) throw error;
                
                showToast('‚úÖ', '√öspƒõch', 'Biometrick√© ovƒõ≈ôen√≠ bylo odebr√°no', 'success');
                loadUsers(); // Aktualizovat seznam u≈æivatel≈Ø
                
            } catch (error) {
                console.error('Chyba p≈ôi odeb√≠r√°n√≠ biometrick√©ho ovƒõ≈ôen√≠:', error);
                showToast('‚ùå', 'Chyba', 'Chyba p≈ôi odeb√≠r√°n√≠ biometrick√©ho ovƒõ≈ôen√≠', 'error');
            }
        }
        // ===== Funkce pro odv√°pnƒõn√≠ =====
        
        // Zobrazen√≠ dialogu pro ovƒõ≈ôen√≠ identity pro odv√°pnƒõn√≠
        function showDescalingAuthPrompt() {
            // Schovat hlavn√≠ p≈ôihla≈°ovac√≠ obrazovku
            const loginScreen = document.getElementById('loginScreen');
            if (loginScreen) {
                loginScreen.classList.add('hidden');
            }
            
            // Zobrazit dialog pro odv√°pnƒõn√≠
            const descalingAuthPrompt = document.getElementById('descalingAuthPrompt');
            if (descalingAuthPrompt) {
                descalingAuthPrompt.classList.remove('hidden');
            }
            
            // Resetovat input pole
            const descalingRfidInput = document.getElementById('descalingRfidInput');
            if (descalingRfidInput) {
                descalingRfidInput.value = '';
                descalingRfidInput.focus();
            }
            
            // Schovat p≈ô√≠padn√© chybov√© hl√°≈°ky
            const descalingAuthError = document.getElementById('descalingAuthError');
            if (descalingAuthError) {
                descalingAuthError.classList.add('hidden');
            }
        }
        
        // Zpracov√°n√≠ ovƒõ≈ôen√≠ pro odv√°pnƒõn√≠
        async function handleDescalingAuth(rfidValue = null) {
            try {
                let user = null;
                
                if (rfidValue) {
                    // RFID ovƒõ≈ôen√≠
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .or(`rfid_card_id.eq.${rfidValue},nfc_card_id.eq.${rfidValue}`)
                        .limit(1);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        user = data[0];
                    } else {
                        // Neregistrovan√° karta - umo≈æn√≠me jako HOST
                        user = {
                            id: null,
                            name: 'HOST',
                            rfid_card_id: rfidValue,
                            balance: 0
                        };
                    }
                } else {
                    // Biometrick√© nebo NFC ovƒõ≈ôen√≠ - prob√≠h√° v samostatn√Ωch funkc√≠ch
                    // a vol√° tuto funkci a≈æ po ovƒõ≈ôen√≠
                    return;
                }
                
                // Pokud m√°me u≈æivatele, pokraƒçujeme na formul√°≈ô pro datum
                if (user) {
                    // Ulo≈æ√≠me ID u≈æivatele do global scope pro pozdƒõj≈°√≠ pou≈æit√≠
                    currentDescalingUser = user;
                    
                    // Skr√Ωt auth dialog
                    document.getElementById('descalingAuthPrompt').classList.add('hidden');
                    
                    // Zobrazit formul√°≈ô pro datum
                    showDescalingDateForm(user);
                    
                    // Zobrazit toast
                    showToast('‚úÖ', 'Ovƒõ≈ôeno', `U≈æivatel ${user.name} √∫spƒõ≈°nƒõ ovƒõ≈ôen`, 'success');
                } else {
                    throw new Error('Nepoda≈ôilo se ovƒõ≈ôit u≈æivatele');
                }
                
            } catch (error) {
                console.error('Chyba p≈ôi ovƒõ≈ôov√°n√≠ pro odv√°pnƒõn√≠:', error);
                document.getElementById('descalingAuthError').textContent = 'Chyba p≈ôi ovƒõ≈ôov√°n√≠. Zkuste to znovu.';
                document.getElementById('descalingAuthError').classList.remove('hidden');
            }
        }
        
        // Pou≈æit√≠ NFC pro ovƒõ≈ôen√≠ odv√°pnƒõn√≠
        async function useNFCForDescaling() {
            try {
                showToast('üì±', 'NFC', 'P≈ôilo≈æte kartu k telefonu...', 'info');
                
                if (!("NDEFReader" in window)) {
                    throw new Error('NFC nen√≠ podporov√°no ve va≈°em prohl√≠≈æeƒçi. Pou≈æijte pros√≠m Chrome na Android za≈ô√≠zen√≠.');
                }
                
                const ndef = new NDEFReader();
                await ndef.scan();
                
                ndef.addEventListener("reading", ({ serialNumber }) => {
                    console.log(`> Serial Number: ${serialNumber}`);
                    handleDescalingAuth(serialNumber);
                });
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi spu≈°tƒõn√≠ NFC p≈ôihl√°≈°en√≠:', error);
                console.error('‚ùå Error name:', error.name);
                console.error('‚ùå Error message:', error.message);
                
                if (error.name === 'NotAllowedError') {
                    showToast('‚ùå', 'NFC Error', 'P≈ô√≠stup k NFC byl zam√≠tnut. Povolte pros√≠m p≈ô√≠stup k NFC ve va≈°em prohl√≠≈æeƒçi.', 'error');
                } else if (error.name === 'NotSupportedError') {
                    showToast('‚ùå', 'NFC Error', 'NFC nen√≠ podporov√°no ve va≈°em prohl√≠≈æeƒçi nebo za≈ô√≠zen√≠. Pou≈æijte Chrome na Android.', 'error');
                } else {
                    showToast('‚ùå', 'NFC Error', `Chyba NFC: ${error.message}`, 'error');
                }
                
                // Vr√°tit se na hlavn√≠ obrazovku
                hideDescalingPrompts();
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen) {
                    loginScreen.classList.remove('hidden');
                }
            }
        }
        
        // Pou≈æit√≠ biometrick√©ho ovƒõ≈ôen√≠ pro odv√°pnƒõn√≠ - robustn√≠ implementace
        async function useBiometricForDescaling() {
            try {
                // Ovƒõ≈ôen√≠ dostupnosti WebAuthn API
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                
                if (!available) {
                    throw new Error('Biometrick√© ovƒõ≈ôen√≠ nen√≠ k dispozici na tomto za≈ô√≠zen√≠');
                }
                
                showToast('üëÜ', 'Biometrick√©', 'Pou≈æijte biometrick√© ovƒõ≈ôen√≠...', 'info');
                
                // Z√≠sk√°n√≠ v≈°ech u≈æivatel≈Ø s biometrick√Ωmi kl√≠ƒçi (kopie z hlavn√≠ho p≈ôihl√°≈°en√≠)
                const { data: usersWithBiometric, error: biometricError } = await supabaseClient
                    .from('users')
                    .select('id, name, biometric_id, rfid_card_id, nfc_card_id, email, balance')
                    .not('biometric_id', 'is', null)
                    .order('name', { ascending: true });
                
                if (biometricError) {
                    console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ biometrick√Ωch kl√≠ƒç≈Ø:', biometricError);
                    throw new Error('Nelze naƒç√≠st registrovan√© biometrick√© kl√≠ƒçe');
                }

                console.log('üîç Nalezen√© biometrick√© kl√≠ƒçe pro odv√°pnƒõn√≠:', usersWithBiometric);
                
                if (!usersWithBiometric || usersWithBiometric.length === 0) {
                    throw new Error('Nejsou registrov√°ny ≈æ√°dn√© biometrick√© kl√≠ƒçe. Zaregistrujte se nejprve v admin sekci.');
                }
                
                // Detailn√≠ log biometrick√Ωch kl√≠ƒç≈Ø pro diagnostiku
                usersWithBiometric.forEach(user => {
                    console.log(`üîç U≈æivatel: ${user.name}, biometric_id form√°t: ${user.biometric_id ? user.biometric_id.substring(0, 10) + '...' : 'null'}`);
                });

                // Vytvo≈ô√≠me allowCredentials ze v≈°ech dostupn√Ωch kl√≠ƒç≈Ø (robustn√≠ verze)
                const allowCredentials = usersWithBiometric
                    .filter(user => !!user.biometric_id) // Ignorujeme p≈ô√≠padn√© null hodnoty
                    .map(user => {
                        console.log('üîç Zpracov√°v√°m biometric_id:', user.biometric_id, 'pro u≈æivatele:', user.name);
                        
                        // Bezpeƒçn√© dek√≥dov√°n√≠ base64 - obaleno v try-catch
                        let rawId;
                        try {
                            // Normalizace base64 ≈ôetƒõzce (odstranƒõn√≠ neplatn√Ωch znak≈Ø)
                            let normalizedId = user.biometric_id;
                            
                            // Nejprve zkontrolujeme form√°t a o≈°et≈ô√≠me p≈ô√≠padn√© abnormality
                            if (normalizedId.includes('-') || normalizedId.includes('_')) {
                                // WebAuthn ƒçasto pou≈æ√≠v√° base64url form√°t, kter√Ω pou≈æ√≠v√° '-' a '_' m√≠sto '+' a '/'
                                normalizedId = normalizedId.replace(/-/g, '+').replace(/_/g, '/');
                                
                                // P≈ô√≠padnƒõ dopln√≠me chybƒõj√≠c√≠ '=' na konci
                                while (normalizedId.length % 4 !== 0) {
                                    normalizedId += '=';
                                }
                                console.log('üîç Normalizovan√Ω base64 ≈ôetƒõzec:', normalizedId);
                            }
                            
                            // Nyn√≠ se pokus√≠me dek√≥dovat
                            rawId = Uint8Array.from(atob(normalizedId), c => c.charCodeAt(0));
                            console.log('‚úÖ √öspƒõ≈°nƒõ dek√≥dov√°n biometric_id pro:', user.name);
                        } catch (decodeError) {
                            console.error('‚ùå Chyba p≈ôi dek√≥dov√°n√≠ biometric_id:', decodeError);
                            console.log('‚ùå Pro u≈æivatele:', user.name);
                            
                            // Pokud se nepoda≈ô√≠ dek√≥dovat, vr√°t√≠me null a pozdƒõji tyto z√°znamy odfiltrujeme
                            return null;
                        }
                        
                        // Vr√°t√≠me credential objekt
                        return {
                            type: 'public-key',
                            id: rawId,
                            transports: ['internal', 'hybrid', 'usb'] // roz≈°√≠≈ôen√° podpora pro r≈Øzn√© transporty
                        };
                    })
                    .filter(cred => cred !== null); // Odstran√≠me v≈°echny neplatn√© credential

                console.log('üîç Prepared allowCredentials pro odv√°pnƒõn√≠:', allowCredentials);

                if (allowCredentials.length === 0) {
                    throw new Error('Nejsou k dispozici ≈æ√°dn√© platn√© biometrick√© kl√≠ƒçe');
                }

                // Vytvo≈ôen√≠ challenge pro autentifikaci
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);
                
                // Efektivn√≠ RP ID (kopie z hlavn√≠ho p≈ôihl√°≈°en√≠)
                const effectiveRpId = (window.location.hostname === 'localhost' || window.location.hostname.startsWith('192.168')) 
                    ? window.location.hostname 
                    : window.location.hostname;
                
                // Robustn√≠ parametry pro autentifikace (kopie z hlavn√≠ho p≈ôihl√°≈°en√≠)
                const publicKeyCredentialRequestOptions = {
                    challenge: challenge,
                    allowCredentials: allowCredentials, // Pou≈æ√≠v√°me konkr√©tn√≠ kl√≠ƒçe z datab√°ze
                    userVerification: 'preferred', // Zmƒõna z 'discouraged' na 'preferred' pro lep≈°√≠ kompatibilitu
                    timeout: 300000, // Del≈°√≠ timeout (5 minut) pro v√≠c ƒçasu na ovƒõ≈ôen√≠
                    rpId: effectiveRpId
                };
                
                console.log('üîç Authentication options pro odv√°pnƒõn√≠:', publicKeyCredentialRequestOptions);
                console.log('üîç Spou≈°t√≠m navigator.credentials.get() pro odv√°pnƒõn√≠...');
                
                const credential = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions,
                    mediation: 'optional' // Povolit mediaci pro lep≈°√≠ UX
                });
                
                if (credential) {
                    // Uspƒõ≈°n√© biometrick√© ovƒõ≈ôen√≠
                    console.log('‚úÖ Biometrick√© ovƒõ≈ôen√≠ pro odv√°pnƒõn√≠ √∫spƒõ≈°n√©!');
                    console.log('üîç credential.id:', credential.id);
                    console.log('üîç credential.rawId:', credential.rawId);
                    console.log('üîç credential.type:', credential.type);
                    
                    // P≈ôevedeme credential.id na base64url string pro porovn√°n√≠ s datab√°z√≠
                    const credentialIdBase64 = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=/g, '');
                    
                    console.log('üîç Credential ID (base64url):', credentialIdBase64);
                    console.log('üîç Credential ID (original):', credential.id);
                    
                    // P≈ôevedeme credential ID na r≈Øzn√© form√°ty pro porovn√°n√≠ (robustn√≠ hled√°n√≠)
                    const credentialIdRaw = credential.id;
                    
                    console.log('üîç Hled√°m u≈æivatele podle credential ID pro odv√°pnƒõn√≠:');
                    console.log('- Raw credential.id:', credentialIdRaw);
                    console.log('- Base64 encoded:', credentialIdBase64);
                    
                    // Flexibilnƒõj≈°√≠ hled√°n√≠ u≈æivatele s ohledem na r≈Øzn√© form√°ty base64
                    let foundUser = null;
                    
                    // Pokus√≠me se naj√≠t u≈æivatele pomoc√≠ r≈Øzn√Ωch transformac√≠ ID
                    for (const user of usersWithBiometric) {
                        console.log(`üîç Porovn√°v√°m s u≈æivatelem: ${user.name}`);
                        
                        if (!user.biometric_id) continue;
                        
                        // P≈ô√≠m√© porovn√°n√≠
                        if (user.biometric_id === credentialIdBase64 || 
                            user.biometric_id === credentialIdRaw) {
                            console.log('‚úÖ Nalezen u≈æivatel p≈ô√≠m√Ωm porovn√°n√≠m:', user.name);
                            foundUser = user;
                            break;
                        }
                        
                        // Normalizovan√© porovn√°n√≠ (base64 vs base64url)
                        let normalizedStoredId = user.biometric_id;
                        if (normalizedStoredId.includes('-') || normalizedStoredId.includes('_')) {
                            normalizedStoredId = normalizedStoredId.replace(/-/g, '+').replace(/_/g, '/');
                            while (normalizedStoredId.length % 4 !== 0) {
                                normalizedStoredId += '=';
                            }
                        }
                        
                        if (normalizedStoredId === credentialIdBase64) {
                            console.log('‚úÖ Nalezen u≈æivatel normalizovan√Ωm porovn√°n√≠m:', user.name);
                            foundUser = user;
                            break;
                        }
                    }
                    
                    if (foundUser) {
                        // Ulo≈æ√≠me ID u≈æivatele do global scope pro pozdƒõj≈°√≠ pou≈æit√≠
                        currentDescalingUser = foundUser;
                        
                        // Skr√Ωt auth dialog
                        document.getElementById('descalingAuthPrompt').classList.add('hidden');
                        
                        // Zobrazit formul√°≈ô pro datum
                        showDescalingDateForm(foundUser);
                        
                        // Zobrazit toast
                        showToast('‚úÖ', 'Ovƒõ≈ôeno', `U≈æivatel ${foundUser.name} √∫spƒõ≈°nƒõ ovƒõ≈ôen (biometricky)`, 'success');
                    } else {
                        throw new Error('U≈æivatel s t√≠mto biometrick√Ωm ID nebyl nalezen');
                    }
                } else {
                    throw new Error('Biometrick√© ovƒõ≈ôen√≠ selhalo - ≈æ√°dn√© credential vr√°ceno');
                }
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi biometrick√©m ovƒõ≈ôen√≠ pro odv√°pnƒõn√≠:', error);
                console.error('‚ùå Error name:', error.name);
                console.error('‚ùå Error message:', error.message);
                
                if (error.name === 'NotAllowedError') {
                    showToast('‚ùå', 'Biometric Error', 'Biometrick√© ovƒõ≈ôen√≠ bylo zru≈°eno nebo nen√≠ dostupn√©. Pot≈ôebujete se nejprve zaregistrovat v admin sekci.', 'error');
                } else if (error.name === 'NotSupportedError') {
                    showToast('‚ùå', 'Biometric Error', 'Biometrick√© ovƒõ≈ôen√≠ nen√≠ podporov√°no na va≈°em za≈ô√≠zen√≠ nebo prohl√≠≈æeƒçi. Zkuste Edge nebo Chrome.', 'error');
                } else if (error.name === 'InvalidStateError') {
                    showToast('‚ùå', 'Biometric Error', 'Nejsou k dispozici ≈æ√°dn√© p≈ô√≠stupov√© kl√≠ƒçe na tomto za≈ô√≠zen√≠. Zkuste se nejprve zaregistrovat v admin sekci.', 'error');
                } else {
                    showToast('‚ùå', 'Biometric Error', `Chyba biometrick√©ho ovƒõ≈ôen√≠: ${error.message}`, 'error');
                }
                
                // Vr√°tit se na hlavn√≠ obrazovku
                hideDescalingPrompts();
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen) {
                    loginScreen.classList.remove('hidden');
                }
            }
        }
        
        // Zobrazen√≠ formul√°≈ôe pro zad√°n√≠ datumu odv√°pnƒõn√≠
        function showDescalingDateForm(user) {
            // Skr√Ωt p≈ô√≠padn√© dialogy a zobrazit formul√°≈ô
            hideDescalingPrompts();
            document.getElementById('descalingDateForm').classList.remove('hidden');
            
            // Nastavit dne≈°n√≠ datum jako v√Ωchoz√≠
            const today = new Date();
            const dateField = document.getElementById('descalingDate');
            dateField.valueAsDate = today;
            dateField.max = today.toISOString().split('T')[0]; // Omezit na dne≈°n√≠ datum
        }
        
        // Skr√Ωt v≈°echny dialogy odv√°pnƒõn√≠
        function hideDescalingPrompts() {
            document.getElementById('descalingAuthPrompt').classList.add('hidden');
            document.getElementById('descalingDateForm').classList.add('hidden');
        }
        
        // Ulo≈æen√≠ z√°znamu o odv√°pnƒõn√≠ do datab√°ze
        async function saveDescalingRecord() {
            try {
                if (!currentDescalingUser) {
                    throw new Error('Chyb√≠ u≈æivatelsk√° identifikace');
                }
                
                // Z√≠skat datum z formul√°≈ôe
                const descalingDate = document.getElementById('descalingDate').value;
                if (!descalingDate) {
                    throw new Error('Pros√≠m zadejte platn√© datum');
                }
                
                // Form√°tovat datum pro zobrazen√≠ v ƒçe≈°tinƒõ
                const formattedDate = new Date(descalingDate)
                    .toLocaleDateString('cs-CZ', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                
                // Vytvo≈ôen√≠ transakce
                const { data, error } = await supabaseClient
                    .from('transactions')
                    .insert([
                        {
                            user_id: currentDescalingUser.id,
                            type: 'descaling',
                            amount: 0,
                            description: `Odv√°pnƒõn√≠ provedeno ${formattedDate}`
                        }
                    ]);
                
                if (error) throw error;
                
                // Zobrazit toast
                showToast('‚úÖ', '√öspƒõch', `Z√°znam o odv√°pnƒõn√≠ byl ulo≈æen (${formattedDate})`, 'success');
                
                // Aktualizovat posledn√≠ datum odv√°pnƒõn√≠
                loadLastDescalingDate();
                
                // Skr√Ωt formul√°≈ô a vr√°tit se na hlavn√≠ obrazovku
                hideDescalingPrompts();
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen) {
                    loginScreen.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ z√°znamu o odv√°pnƒõn√≠:', error);
                showToast('‚ùå', 'Chyba', `Nepoda≈ôilo se ulo≈æit z√°znam: ${error.message}`, 'error');
                
                // Vr√°tit se na hlavn√≠ obrazovku
                hideDescalingPrompts();
                const loginScreen2 = document.getElementById('loginScreen');
                if (loginScreen2) {
                    loginScreen2.classList.remove('hidden');
                }
            }
        }
        
        // Naƒçten√≠ posledn√≠ho datumu odv√°pnƒõn√≠
        async function loadLastDescalingDate() {
            try {
                const { data, error } = await supabaseClient
                    .from('transactions')
                    .select('*')
                    .eq('type', 'descaling')
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                const lastDescalingDateEl = document.getElementById('lastDescalingDate');
                
                if (data && data.length > 0) {
                    const lastRecord = data[0];
                    const descriptionMatch = lastRecord.description.match(/Odv√°pnƒõn√≠ provedeno (\d{2}\.\d{2}\.\d{4})/);
                    
                    if (descriptionMatch && descriptionMatch[1]) {
                        lastDescalingDateEl.textContent = `Posledn√≠: ${descriptionMatch[1]}`;
                    } else {
                        // Pokud popis neobsahuje datum, pou≈æijeme datum vytvo≈ôen√≠ z√°znamu
                        const createdDate = new Date(lastRecord.created_at)
                            .toLocaleDateString('cs-CZ', { 
                                day: '2-digit', 
                                month: '2-digit', 
                                year: 'numeric' 
                            });
                        lastDescalingDateEl.textContent = `Posledn√≠: ${createdDate}`;
                    }
                } else {
                    lastDescalingDateEl.textContent = '≈Ω√°dn√Ω z√°znam';
                }
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ posledn√≠ho datumu odv√°pnƒõn√≠:', error);
                document.getElementById('lastDescalingDate').textContent = 'Chyba naƒç√≠t√°n√≠';
            }
        }
        
        // Inicializace glob√°ln√≠ promƒõnn√© pro aktu√°ln√≠ho u≈æivatele odv√°pnƒõn√≠
        let currentDescalingUser = null;
        
        // Event Listeners pro odv√°pnƒõn√≠
        document.addEventListener('DOMContentLoaded', () => {
            // Tlaƒç√≠tko pro odv√°pnƒõn√≠
            const descalingBtn = document.getElementById('descalingBtn');
            if (descalingBtn) {
                descalingBtn.addEventListener('click', () => {
                    showDescalingAuthPrompt();
                });
            }
            
            // RFID input pro odv√°pnƒõn√≠
            const descalingRfidInput = document.getElementById('descalingRfidInput');
            if (descalingRfidInput) {
                descalingRfidInput.addEventListener('input', (event) => {
                    const value = event.target.value.trim();
                    if (value.length >= 10) {
                        handleDescalingAuth(value);
                    }
                });
            }
            
            // NFC tlaƒç√≠tko pro odv√°pnƒõn√≠
            const descalingNfcBtn = document.getElementById('descalingNfcBtn');
            if (descalingNfcBtn) {
                descalingNfcBtn.addEventListener('click', () => {
                    useNFCForDescaling();
                });
            }
            
            // Biometrick√© tlaƒç√≠tko pro odv√°pnƒõn√≠
            const descalingBioBtn = document.getElementById('descalingBioBtn');
            if (descalingBioBtn) {
                descalingBioBtn.addEventListener('click', () => {
                    useBiometricForDescaling();
                });
            }
            
            // Zru≈°it tlaƒç√≠tko pro auth dialog
            const cancelDescalingAuthBtn = document.getElementById('cancelDescalingAuthBtn');
            if (cancelDescalingAuthBtn) {
                cancelDescalingAuthBtn.addEventListener('click', () => {
                    hideDescalingPrompts();
                    const loginScreen = document.getElementById('loginScreen');
                    if (loginScreen) {
                        loginScreen.classList.remove('hidden');
                    }
                });
            }
            
            // Tlaƒç√≠tko pro ulo≈æen√≠ z√°znamu o odv√°pnƒõn√≠
            const saveDescalingBtn = document.getElementById('saveDescalingBtn');
            if (saveDescalingBtn) {
                saveDescalingBtn.addEventListener('click', () => {
                    saveDescalingRecord();
                });
            }
            
            // Zru≈°it tlaƒç√≠tko pro formul√°≈ô datumu
            const cancelDescalingDateBtn = document.getElementById('cancelDescalingDateBtn');
            if (cancelDescalingDateBtn) {
                cancelDescalingDateBtn.addEventListener('click', () => {
                    hideDescalingPrompts();
                    const loginScreen = document.getElementById('loginScreen');
                    if (loginScreen) {
                        loginScreen.classList.remove('hidden');
                    }
                });
            }
            
            // Naƒç√≠st posledn√≠ datum odv√°pnƒõn√≠ p≈ôi startu
            loadLastDescalingDate();
        });
    </script>
</body>
</html>